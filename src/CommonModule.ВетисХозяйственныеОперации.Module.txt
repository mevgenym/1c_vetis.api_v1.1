
Функция ПолучитьСписокПредприятийПоХС(пХС, пТолькоПервое = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_Таблица.Предприятие
	|ИЗ
	|	РегистрСведений.ВетисBusinessMembers КАК _Таблица
	|ГДЕ
	|	_Таблица.ХозяйствующийСубъект = &ХС";
	
	Запрос.УстановитьПараметр("ХС", пХС);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_Список = Новый Массив;
	Пока Выборка.Следующий() Цикл
		Если пТолькоПервое = Истина Тогда
			Возврат Выборка.Предприятие;
		КонецЕсли;
		_Список.Добавить(Выборка.Предприятие);
	КонецЦикла;
	
	Возврат _Список;
	
КонецФункции

Функция ПолучитьПредприятиеПоСкладу(пСклад, ПоУмолчанию = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	_Таблица.Ссылка КАК Предриятие
	|ИЗ
	|	Справочник.ВетисEnterprise КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.Склад = &Склад";
	
	Запрос.УстановитьПараметр("Склад", пСклад);
	
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Предриятие;
	Иначе
		Возврат ПоУмолчанию;
	КонецЕсли;
	
КонецФункции

Процедура ПривязатьХСПредприятие(пХС, пПредприятие) Экспорт
	
	_мз = РегистрыСведений.ВетисBusinessMembers.СоздатьМенеджерЗаписи();
	_мз.BusinessEntity = пХС;
	_мз.Enterprise = пПредприятие;
	_мз.ВСервисе = Ложь;
	_мз.Записать();
	
КонецПроцедуры

Процедура ОтвязатьХСПредприятие(пХС, пПредприятие) Экспорт
	
	_мз = РегистрыСведений.ВетисBusinessMembers.СоздатьМенеджерЗаписи();
	_мз.BusinessEntity = пХС;
	_мз.Enterprise = пПредприятие;
	_мз.Удалить();
	
КонецПроцедуры

Процедура ОбновитьСвязиХСПредприятие(пХС = Неопределено, пОтказ = Ложь, пОшибка = "") Экспорт
	
	_Версия20 = Ветис.Версия_2_0();
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	_Таблица.BusinessEntity КАК ХозяйствующийСубъект,
	|	_Таблица.Enterprise КАК Предприятие,
	|	_Таблица.ВСервисе,
	|	_Таблица.Enterprise.guid КАК EnterpriseGuid,
	|	_Таблица.BusinessEntity.guid КАК BusinessEntityGuid
	|ИЗ
	|	РегистрСведений.ВетисBusinessMembers КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|//1	И _Таблица.BusinessEntity = &ХС
	|	И ИСТИНА
	|ИТОГИ
	|	МАКСИМУМ(BusinessEntityGuid)
	|ПО
	|	ХозяйствующийСубъект";
	
	_нз = РегистрыСведений.ВетисBusinessMembers.СоздатьНаборЗаписей();
	_нз.ОбменДанными.Загрузка = Истина;
	Если НЕ пХС = Неопределено Тогда
		_нз.Отбор.ХозяйствующийСубъект.Установить(пХС);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//1", "");
		Запрос.УстановитьПараметр("ХС", пХС);
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	ВыборкаХС = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаХС.Следующий() Цикл
		
		_список = Новый Массив;
		_Enterprise = Неопределено;
		_параметры = Неопределено;
		Если _Версия20 Тогда
			Пока ВетисEnterpriseService_2_0.GetActivityLocationListNext(ВыборкаХС.BusinessEntityGuid, _Enterprise, _параметры, пОтказ, пОшибка) Цикл
				_список.Добавить(_Enterprise.guid);
			КонецЦикла;
		Иначе
			Пока ВетисEnterpriseService.GetActivityLocationListNext(ВыборкаХС.BusinessEntityGuid, _Enterprise, _параметры, пОтказ, пОшибка) Цикл
				_список.Добавить(_Enterprise.guid);
			КонецЦикла;
		КонецЕсли;
		
		Если пОтказ = Истина Тогда
			Возврат;
		КонецЕсли;
		
		Выборка = ВыборкаХС.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			Если Выборка.EnterpriseGuid = NULL ИЛИ Выборка.BusinessEntityGuid = NULL ИЛИ _список.Найти(Выборка.EnterpriseGuid) = Неопределено Тогда
				_ВСервисе = Ложь;
			Иначе
				_ВСервисе = Истина;
			КонецЕсли;
			
			_мз = _нз.Добавить();
			_мз.BusinessEntity = Выборка.ХозяйствующийСубъект;
			_мз.Enterprise = Выборка.Предприятие;
			_мз.ВСервисе = _ВСервисе;
			
		КонецЦикла;
	КонецЦикла;
	
	_нз.Записать();
	
КонецПроцедуры
