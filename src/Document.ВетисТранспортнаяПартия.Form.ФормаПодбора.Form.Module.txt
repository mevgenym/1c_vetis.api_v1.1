
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("Enterprise") Тогда
		ВетисОбщегоНазначения.ДобавитьОтбор(Список.Отбор, "Enterprise", Параметры.Enterprise);
	КонецЕсли;
	
	Если Параметры.Свойство("BusinessEntity") Тогда
		ВетисОбщегоНазначения.ДобавитьОтбор(Список.Отбор, "BusinessEntity", Параметры.BusinessEntity);
	КонецЕсли;
	
	ЗакрыватьПриВыборе = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаВыбрать(Команда)
	
	Если Элементы.СписокСкладскойЖурнал.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	_ТекущиеДанные = Элементы.СписокСкладскойЖурнал.ТекущиеДанные;
	
	Для каждого _ТекущиеДанные Из Выбранное Цикл
		ЗначениеВыбора = Новый Структура;
		ЗначениеВыбора.Вставить("Ссылка",            _ТекущиеДанные.Ссылка);
		ЗначениеВыбора.Вставить("Unit",            _ТекущиеДанные.Unit);
		ЗначениеВыбора.Вставить("Количество",      _ТекущиеДанные.Количество);
		ЗначениеВыбора.Вставить("Упаковка",        ПолучитьУпаковку(_ТекущиеДанные.Ссылка));
		
		ОповеститьОВыборе(ЗначениеВыбора);
	КонецЦикла;
	
	Закрыть();
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьУпаковку(пСсылка) 
	
	_список = Новый Массив;
	
	_Объект = пСсылка.ПолучитьОбъект();
	
	Для каждого _Package Из _Объект.PackageList Цикл
		
		_Маркировка = Новый Массив;
		
		Для каждого _ProductMark Из _Объект.ProductMarks Цикл
			Если _Package.КлючСтроки = _ProductMark.КлючСвязи Тогда
				_Маркировка.Добавить(Новый Структура("КлючСвязи,Маркировка,КлассМаркировки",_ProductMark.КлючСвязи,_ProductMark.value,_ProductMark.class));
			КонецЕсли;
		КонецЦикла;
		
		_строка = Новый Структура();
		_строка.Вставить("КлючСтроки",_Package.КлючСтроки);
		_строка.Вставить("Уровень",_Package.level);
		_строка.Вставить("Упаковка",_Package.packingType);
		_строка.Вставить("Количество",_Package.quantity);
		_строка.Вставить("Маркировка", _Маркировка);
		
		_список.Добавить(_строка);
		
	КонецЦикла;
	
	Возврат _список;
	
КонецФункции


&НаКлиенте
Процедура СписокПартииВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ОткрытьФорму("Документ.ВетисТранспортнаяПартия.Форма.ФормаВводаКоличества", Новый Структура("Количество", Элемент.ТекущиеДанные.volume), ЭтаФорма,,,, Новый ОписаниеОповещения("СписокПартииВыборОбработкаОповещения", ЭтаФорма));
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПартииВыборОбработкаОповещения(Результат, Параметры) Экспорт
	
	Если НЕ Результат = Неопределено Тогда
		
		Если Элементы.СписокСкладскойЖурнал.ТекущиеДанные = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		_ТекущиеДанные = Элементы.СписокСкладскойЖурнал.ТекущиеДанные;
		
		_строки = Выбранное.НайтиСтроки(Новый Структура("Ссылка", _ТекущиеДанные.Ссылка));
		
		Если _строки.Количество() = 0 Тогда
			ЗначениеВыбора = Выбранное.Добавить();
			ЗначениеВыбора.Ссылка = _ТекущиеДанные.Ссылка;
			ЗначениеВыбора.Unit = _ТекущиеДанные.Unit;
		Иначе
			ЗначениеВыбора = _строки[0];
		КонецЕсли;
		
		ЗначениеВыбора.Количество = Результат;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПартииПриАктивизацииСтроки(Элемент)
	
	_ТекущиеДанные = Элементы.СписокСкладскойЖурнал.ТекущиеДанные;
	
	Если _ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	//ВетисОбщегоНазначенияКлиентСервер.ДобавитьОтбор(СписокСкладскойЖурналУпаковка.Отбор, "guid", _ТекущиеДанные.guid);
	//ВетисОбщегоНазначенияКлиентСервер.ДобавитьОтбор(СписокСкладскойЖурналМаркировка.Отбор, "guid", _ТекущиеДанные.guid);
	
КонецПроцедуры

&НаКлиенте
Процедура СписокСкладскойЖурналУпаковкаПриАктивизацииСтроки(Элемент)
	
	//_ТекущиеДанные = Элементы.СписокСкладскойЖурналУпаковка.ТекущиеДанные;
	//
	//Если _ТекущиеДанные = Неопределено Тогда
	//	Возврат;
	//КонецЕсли;
	
	//ВетисОбщегоНазначенияКлиентСервер.ДобавитьОтбор(СписокСкладскойЖурналМаркировка.Отбор, "КлючСвязи", _ТекущиеДанные.КлючСтроки);
	
КонецПроцедуры
