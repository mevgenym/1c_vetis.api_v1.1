
Функция ОбработатьВходящийЗапрос(пЗапрос) Экспорт
	
	//ВетисОбщегоНазначения.Пауза(10);
	
	_Отказ = Ложь;
	
	_Обновление = Истина;
	
	_Сообщение = "";
	
	_Запрос = Десериализовать(пЗапрос.ПолучитьТелоКакСтроку());
	
	Если НЕ ТипЗнч(_Запрос) = Тип("ХранилищеЗначения") Тогда
		Возврат ОтветСервер("Неправильный формат запроса", Истина);
	КонецЕсли;
	
	_Запрос = _Запрос.Получить();
	
	//проверка запроса
	Если НЕ ТипЗнч(_Запрос) = Тип("Структура") Тогда
		Возврат ОтветСервер("Неправильный формат запроса", Истина);
	КонецЕсли;
	
	//обработчик
	_ответ = Новый Структура;
	//_Выгруженные = Неопределено;
	Если _Запрос.Свойство("BusinessEntity") И ТипЗнч(_Запрос.BusinessEntity) = Тип("Массив") Тогда
		_ответ.Вставить("BusinessEntity", Новый Массив);
		Для каждого _ЗапросBusinessEntity Из _Запрос.BusinessEntity Цикл
			_Отказ = Ложь; _Ошибка = "";
			Если _ЗапросBusinessEntity.Свойство("inn") И ЗначениеЗаполнено(_ЗапросBusinessEntity.inn) Тогда
				_список = Новый Массив;
				_ссылка = Справочники.ВетисBusinessEntity.НайтиПоРеквизиту("inn", _ЗапросBusinessEntity.inn);
				Если ЗначениеЗаполнено(_ссылка) Тогда
					_список.Добавить(ПолучитьСтруктуруОбъекта(_ссылка));
				Иначе
					_ОтветСервиса = ВетисEnterpriseService_2_0.GetBusinessEntityByINN(_ЗапросBusinessEntity.inn, _Отказ, _Ошибка);
					Если _Отказ = Истина Тогда
						Возврат ОтветСервер(_Ошибка);
					КонецЕсли;
					Для каждого _ОбъектСервиса Из _ОтветСервиса Цикл
						_список.Добавить(ПолучитьСтруктуруОбъекта(ВетисDictionaryСлой1с.BusinessEntity(_ОбъектСервиса)));
					КонецЦикла;
				КонецЕсли;
				_ответ.BusinessEntity.Добавить(Новый Структура("inn, Объекты", _ЗапросBusinessEntity.inn, _список));
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ОтветСервер(_Сообщение, ,, _ответ);
	
КонецФункции


Функция ОтветСервер(пСообщение, пОтказ = Ложь, пГотово = Ложь, пОтвет = Неопределено)
	
	_Ответ = Новый Структура("Готово,Отказ,Сообщение,Ответ", пГотово, пОтказ, пСообщение, пОтвет);
	
	_Ответ = Новый ХранилищеЗначения(_Ответ, Новый СжатиеДанных(9));
	
	Возврат Сериализовать(_Ответ);
	
КонецФункции


Функция Сериализовать(пОбъект) Экспорт
	
	_ЗаписьXML = Новый ЗаписьXML;
	_ЗаписьXML.УстановитьСтроку("UTF-8");
	
	ЗаписатьXML(_ЗаписьXML, пОбъект);
	
	Возврат _ЗаписьXML.Закрыть();
	
КонецФункции

Функция Десериализовать(пТекст) Экспорт
	
	_Чтение = Новый ЧтениеXML;
	
	_Чтение.УстановитьСтроку(пТекст);
	
	_Результат = ПрочитатьXML(_Чтение);
	
	_Чтение.Закрыть();
	
	Возврат _Результат;
	
КонецФункции

Функция ПолучитьСтруктуруОбъекта(пОбъект, пВыгруженные = Неопределено, пПодробно = Истина, пПодробноПоСсылке = Истина)
	
	Возврат ВетисОбщегоНазначения.ПолучитьСтруктуруОбъектаДляОбмена(пОбъект, пВыгруженные, пПодробно, пПодробноПоСсылке)
	
КонецФункции
