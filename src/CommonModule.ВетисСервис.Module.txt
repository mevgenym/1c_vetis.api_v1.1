
Функция ОбработатьВходящийЗапрос(пЗапрос) Экспорт
	
	//ВетисОбщегоНазначения.Пауза(10);
	
	_Отказ = Ложь;
	_ответ = Новый Структура;
	_Ошибка = "";
	
	_Обновление = Истина;
	
	//_Сообщение = "";
	
	_Запрос = Десериализовать(пЗапрос.ПолучитьТелоКакСтроку());
	
	Если НЕ ТипЗнч(_Запрос) = Тип("ХранилищеЗначения") Тогда
		Возврат ОтветСервер("Неправильный формат запроса", Истина);
	КонецЕсли;
	
	_Запрос = _Запрос.Получить();
	
	//проверка запроса
	Если НЕ ТипЗнч(_Запрос) = Тип("Структура") Тогда
		Возврат ОтветСервер("Неправильный формат запроса", Истина);
	КонецЕсли;
	
	//Если _Запрос.Свойство("НомерПринятого") Тогда
	//	ПланыОбмена.ВетисКлиенты.УстановитьНомерПринятого(_Запрос.НомерПринятого);
	//КонецЕсли;
	//
	//Если _Запрос.Свойство("Изменения") Тогда
	//	Для каждого _ОбъектСтруктура Из _Запрос.Изменения Цикл
	//		Если _ОбъектСтруктура.Тип = Метаданные.Документы.ВетисТранспортнаяПартия.ПолноеИмя() Тогда
	//			ОбработатьСсылку(_ОбъектСтруктура, _Ошибка, Истина);
	//			Если НЕ _Ошибка = "" Тогда
	//				Возврат ОтветСервер(_Ошибка, Истина);
	//			КонецЕсли;
	//		Иначе
	//			ОбработатьСсылку(_ОбъектСтруктура, _Ошибка);
	//			Если НЕ _Ошибка = "" Тогда
	//				Возврат ОтветСервер(_Ошибка, Истина);
	//			КонецЕсли;
	//		КонецЕсли;
	//	КонецЦикла;
	//КонецЕсли;
	//
	//НомерОтправленного = 0;
	//
	//_Ответ.Вставить("Изменения", ВыбратьИзменения(НомерОтправленного));
	//
	//_Ответ.Вставить("НомерОтправленного", НомерОтправленного);
	
	//обработчик
	Для каждого _Блок Из _Запрос Цикл
		_Имя = _Блок.Ключ;
		_Блок = _Блок.Значение;
		Если Ложь Тогда
			
		//ИначеЕсли _Имя = "Объекты" Тогда
			
		ИначеЕсли _Имя = "ТранспортнаяПартия" Тогда
			Если ТипЗнч(_Блок) = Тип("Структура") Тогда
				_Ответ.Вставить("ТранспортнаяПартия", Новый Массив);
				Если ТипЗнч(_Блок.Объекты) = Тип("Массив") Тогда
					_Объекты = _Блок.Объекты;
				Иначе
					_Объекты = Новый Массив;
					_Объекты.Добавить(_Блок.Объекты);
				КонецЕсли;
				Для каждого _ЗапросОбъект Из _Объекты Цикл
					Если НЕ (ТипЗнч(_ЗапросОбъект) = Тип("Структура"))
						ИЛИ НЕ _ЗапросОбъект.Свойство("ref")
						ИЛИ ПустаяСтрока(_ЗапросОбъект.ref)
						ИЛИ _ЗапросОбъект.ref = "00000000-0000-0000-0000-000000000000" Тогда
						Возврат ОтветСервер("Некорректные входные данные", Истина);
					КонецЕсли;
					_ref = Новый УникальныйИдентификатор(_ЗапросОбъект.ref);
					_Ссылка = Документы.ВетисТранспортнаяПартия.ПолучитьСсылку(_ref);
					_Объект = _Ссылка.ПолучитьОбъект();
					_ОбъектСтруктура = Новый Структура;
					_ОбъектСтруктура.Вставить("ref", _ЗапросОбъект.ref);
					_ОбъектСтруктура.Вставить("Партии", Новый Массив);
					Если _Объект = Неопределено Тогда
						_ОбъектСтруктура.Вставить("Статус", ПолучитьСтруктуруОбъекта(Перечисления.ВетисVetDocumentStatus.ПустаяСсылка()));
					Иначе
						_ОбъектСтруктура.Вставить("Статус", ПолучитьСтруктуруОбъекта(_Объект.Статус));
						_ОбъектСтруктура.Вставить("Партии", Новый Массив);
						Для каждого _ПартииСтрока Из _Объект.Партии Цикл
							_ПартииСтруктура = Новый Структура;
							_ПартииСтруктура.Вставить("НомерСтроки", _ПартииСтрока.НомерСтроки);
							_ПартииСтруктура.Вставить("Количество", _ПартииСтрока.Количество);
							_ПартииСтруктура.Вставить("ProductItemName", _ПартииСтрока.ProductItemName);
							//_ПартииСтруктура.Вставить("ЗаписьСЖ", ПолучитьСтруктуруОбъекта(_ПартииСтрока.ЗаписьСЖ));
							_ПартииСтруктура.Вставить("Статус", ПолучитьСтруктуруОбъекта(_ПартииСтрока.Статус));
							
							_StockEntry = Новый Структура;
							ОбработатьStockEntry(Новый Структура("Ссылка", _ПартииСтрока.ЗаписьСЖ), _StockEntry);
							Если _StockEntry.StockEntry.Количество() >0 Тогда
								_ПартииСтруктура.Вставить("ЗаписьСЖ", _StockEntry.StockEntry[0]);
							Иначе
								_ПартииСтруктура.Вставить("ЗаписьСЖ", Новый Структура);
							КонецЕсли;
							
							_VetDocument = Новый Структура;
							ОбработатьVetDocument(Новый Структура("Ссылка", _ПартииСтрока.ВСД), _VetDocument);
							Если _VetDocument.VetDocument.Количество() >0 Тогда
								_ПартииСтруктура.Вставить("ВСД", _VetDocument.VetDocument[0]);
							Иначе
								_ПартииСтруктура.Вставить("ВСД", Новый Структура);
							КонецЕсли;
							
							_ОбъектСтруктура.Партии.Добавить(_ПартииСтруктура);
						КонецЦикла;
					КонецЕсли;
					_Ответ.ТранспортнаяПартия.Добавить(_ОбъектСтруктура);
				КонецЦикла;
			Иначе
				Если ТипЗнч(_Блок) = Тип("Массив") Тогда
					Для каждого _ЗапросОбъект Из _Блок Цикл
						Если НЕ ОбработатьТранспортнаяПартия(_ЗапросОбъект, _Ответ, _Ошибка) Тогда
							Возврат ОтветСервер(_Ошибка, Истина);
						КонецЕсли;
					КонецЦикла;
				Иначе
					Если НЕ ОбработатьТранспортнаяПартия(_Блок, _Ответ, _Ошибка) Тогда
						Возврат ОтветСервер(_Ошибка, Истина);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли _Имя = "VetDocument" Тогда
			Если НЕ ОбработатьVetDocument(_Блок, _Ответ, _Ошибка) Тогда
				Возврат ОтветСервер(_Ошибка, Истина);
			КонецЕсли;
			
		ИначеЕсли _Имя = "StockEntry" Тогда
			Если НЕ ОбработатьStockEntry(_Блок, _Ответ, _Ошибка) Тогда
				Возврат ОтветСервер(_Ошибка, Истина);
			КонецЕсли;
			
		ИначеЕсли _Имя = "BusinessEntity" Тогда
			Если НЕ ОбработатьBusinessEntity(_Блок, _Ответ, _Ошибка) Тогда
				Возврат ОтветСервер(_Ошибка, Истина);
			КонецЕсли;
			
		ИначеЕсли _Имя = "РеализацияТоваровУслуг"
			ИЛИ _Имя = "РасходныйОрдерНаТовары"
			ИЛИ _Имя = "ПриходныйОрдерНаТовары"
			ИЛИ _Имя = "ПоступлениеТоваровУслуг"
			ИЛИ _Имя = "ПеремещениеТоваров"
			ИЛИ _Имя = "ИнвентаризацияТоваровНаСкладе" Тогда
			
			Если ТипЗнч(_Блок) = Тип("Массив") Тогда
				Для каждого _ЗапросОбъект Из _Блок Цикл
					ОбработатьСсылку(_ЗапросОбъект, _Ошибка, Истина);
				КонецЦикла;
			Иначе
				ОбработатьСсылку(_Блок, _Ошибка, Истина);
			КонецЕсли;
			
		ИначеЕсли _Имя = "Enterprise" Тогда
			Если НЕ ОбработатьEnterprise(_Блок, _Ответ, _Ошибка) Тогда
				Возврат ОтветСервер(_Ошибка, Истина);
			КонецЕсли;
			
		ИначеЕсли _Имя = "Country" Тогда
			ОбработатьCountry(_Блок, _Ответ, _Ошибка);
			
		ИначеЕсли _Имя = "Region" Тогда
			ОбработатьRegion(_Блок, _Ответ, _Ошибка);
			
		ИначеЕсли _Имя = "Locality" Тогда
			ОбработатьLocality(_Блок, _Ответ, _Ошибка);
			
		КонецЕсли;
	КонецЦикла;
	
	Возврат ОтветСервер(_Ошибка, НЕ ПустаяСтрока(_Ошибка),, _ответ);
	
КонецФункции

Функция ОбработатьТранспортнаяПартия(пОбъект, пОтвет, пОшибка)
	
	Если НЕ (ТипЗнч(пОбъект) = Тип("Структура")) Тогда
		пОшибка = "Некорректные входные данные";
		Возврат Ложь;
	КонецЕсли;
	
	_Ссылка = Неопределено;
	
	_менеджер = Документы.ВетисТранспортнаяПартия;
	
	//Если НЕ пОшибка = "" Тогда
	//	Возврат Неопределено;
	//КонецЕсли;
	
	Если НЕ пОбъект.Свойство("ref") Тогда
		Возврат _менеджер.ПустаяСсылка();
	КонецЕсли;
	
	Если пОбъект.ref = "00000000-0000-0000-0000-000000000000" Тогда
		Возврат _менеджер.ПустаяСсылка();
	КонецЕсли;
	
	_Метаданные = _менеджер.ПустаяСсылка().Метаданные();
	
	_ref = Новый УникальныйИдентификатор(пОбъект.ref);
	
	_Ссылка = _менеджер.ПолучитьСсылку(_ref);
	
	_Объект = _Ссылка.ПолучитьОбъект();
	
	Если _Объект = Неопределено Тогда
		_Объект = _менеджер.СоздатьДокумент();
		_Объект.Дата = ТекущаяДата();
		//_Объект.Ответственный = Ветис.ТекущийПользователь();
		
		_всд = _Объект.ВСД.Добавить();
		_всд.НазначениеГруза       = Ветис.Настройки_ВСД_НазначениеГруза();
		_всд.БлагополучиеМестности = Ветис.Настройки_ВСД_БлагополучиеМестности();
		_всд.Ветсанэкспертиза20    = Ветис.Настройки_ВСД_ВСЭ();
		_всд.КонтрольГосВетврачем  = Ветис.Настройки_ВСД_КонтрольГосВетврачем();
		
		_ттн = _Объект.ТТН.Добавить();
		_ттн.Дата      = ТекущаяДата();
		_ттн.Тип       = Перечисления.ВетисDocumentType.ТовароТранспортнаяНакладная;
		_ттн.Транспорт = Ветис.Настройки_ТТН_Транспорт();
		
		Если ЗначениеЗаполнено(_ттн.Транспорт) Тогда
			_ттн.ТипТранспорта  = _ттн.Транспорт.ТипТранспорта;
			_ттн.НомерТранспорта= _ттн.Транспорт.Номер;
			_ттн.НомерПрицепа   = _ттн.Транспорт.НомерПрицепа;
			_ттн.Посредник      = _ттн.Транспорт.Перевозчик;
			_ттн.СпособХранения = _ттн.Транспорт.СпособХранения;
		Иначе
			_ттн.ТипТранспорта  = Перечисления.ВетисTransportType.Автомобильный;
			_ттн.Посредник      = Ветис.Настройки_ТТН_Посредник();
			_ттн.СпособХранения = Ветис.Настройки_ТТН_СпособХранения();
		КонецЕсли;
		_Объект.УстановитьСсылкуНового(_Ссылка);
	КонецЕсли;
	
	ЗаполнитьРеквизиты(_Метаданные.Реквизиты, _Объект, пОбъект, пОшибка);
	
	Если НЕ пОшибка = "" Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если пОбъект.Свойство("ТТН") Тогда
		_ттн = ?(_Объект.ТТН.Количество() = 0, _Объект.ТТН.Добавить(), _Объект.ТТН.Получить(0));
		пОбъект.ТТН.Свойство("Дата", _ттн.Дата);
		пОбъект.ТТН.Свойство("Номер", _ттн.Номер);
		пОбъект.ТТН.Свойство("НомерТранспорта", _ттн.НомерТранспорта);
	КонецЕсли;
	
	_Индекс = _Объект.Партии.Количество()-1;
	Пока _Индекс >= 0 Цикл
		
		_ПартииСтрока1 = _Объект.Партии[_Индекс];
		
		Если ЗначениеЗаполнено(_ПартииСтрока1.ВСД) Тогда
			_Индекс = _Индекс - 1;
			Продолжить;
		КонецЕсли;
		
		_Найден = Ложь;
		Для каждого _ПартииСтрока2 Из пОбъект.Партии Цикл
			Если _ПартииСтрока1.ЗаписьСЖ.guid = _ПартииСтрока2.ЗаписьСЖ.ref
				ИЛИ _ПартииСтрока1.guid = _ПартииСтрока2.ЗаписьСЖ.ref Тогда
				_Найден = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НЕ _Найден Тогда
			_Объект.Партии.Удалить(_Индекс);
		КонецЕсли;
		
		_Индекс = _Индекс - 1;
		
	КонецЦикла;
	
	Для каждого _ПартииСтрока Из пОбъект.Партии Цикл
		
		_ЗаписьСЖ = ОбработатьСсылку(_ПартииСтрока.ЗаписьСЖ);
		
		_СтрокаПоиска = Новый Структура("ЗаписьСЖ", _ЗаписьСЖ);
		
		_ТЧСтроки = _Объект.Партии.НайтиСтроки(_СтрокаПоиска);
		
		Если _ТЧСтроки.Количество() = 0 Тогда
			_ТЧСтрока = _Объект.Партии.Добавить();
			_список = _Объект.Партии.Выгрузить().ВыгрузитьКолонку("КлючСтроки");
			Для _Индекс = 1 По 999 Цикл
				Если _список.Найти(_Индекс) = Неопределено Тогда
					_ТЧСтрока.КлючСтроки = _Индекс;
					Прервать;
				КонецЕсли;
			КонецЦикла;
		Иначе
			_ТЧСтрока = _ТЧСтроки[0];
			
			Если ЗначениеЗаполнено(_ТЧСтрока.ВСД) Тогда
				Продолжить;
			КонецЕсли;
			
		КонецЕсли;
		
		//_ТЧСтрока.guid = _ПартииСтрока.guid;
		
		_ТЧСтрока.ЗаписьСЖ = _ЗаписьСЖ;
		
		_ТЧСтрока.unit = _ЗаписьСЖ.unit;
		
		_ТЧСтрока.producer = _ЗаписьСЖ.producer;
		
		_ТЧСтрока.Количество = _ПартииСтрока.Количество;
		
		_ТЧСтрока.ProductItemName = _ПартииСтрока.Наименование;
		
	КонецЦикла;
	
	//_Объект.ОбменДанными.Загрузка = Истина;
	_Объект.ПометкаУдаления = Ложь;
	
	_Объект.Проведен = Истина;
	
	Попытка
		_Объект.Записать();
	Исключение
		пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

Функция ОбработатьBusinessEntity(пПараметры, пОтвет, пОшибка)
	
	Если НЕ ТипЗнч(пПараметры) = Тип("Массив") Тогда
		пОшибка = "Некорректные входные данные";
		Возврат Ложь;
	КонецЕсли;
	
	пОтвет.Вставить("BusinessEntity", Новый Массив);
	Для каждого _ЭлементЗапроса Из пПараметры Цикл
		
		_Отказ = Ложь;
		Если _ЭлементЗапроса.Свойство("inn") И ЗначениеЗаполнено(_ЭлементЗапроса.inn) Тогда
			_список = Новый Массив;
			_ссылка = Справочники.ВетисBusinessEntity.НайтиПоРеквизиту("inn", _ЭлементЗапроса.inn);
			Если ЗначениеЗаполнено(_ссылка) Тогда
				_список.Добавить(ПолучитьСтруктуруОбъекта(_ссылка));
			Иначе
				_ОтветСервиса = ВетисEnterpriseService_2_0.GetBusinessEntityByINN(_ЭлементЗапроса.inn, _Отказ, пОшибка);
				Если _Отказ = Истина Тогда
					Возврат Ложь;
				КонецЕсли;
				Для каждого _ОбъектСервиса Из _ОтветСервиса Цикл
					_список.Добавить(ПолучитьСтруктуруОбъекта(ВетисDictionaryСлой1с.BusinessEntity(_ОбъектСервиса)));
				КонецЦикла;
			КонецЕсли;
			пОтвет.BusinessEntity.Добавить(Новый Структура("inn, Объекты", _ЭлементЗапроса.inn, _список));
			
		ИначеЕсли _ЭлементЗапроса.Свойство("guid") И ЗначениеЗаполнено(_ЭлементЗапроса.guid) Тогда
			_список = Новый Массив;
			_ссылка = ВетисDictionaryСлой1с.BusinessEntity(_ЭлементЗапроса.guid);
			_список.Добавить(ПолучитьСтруктуруОбъекта(_ссылка));
			пОтвет.BusinessEntity.Добавить(Новый Структура("guid, Объекты", _ЭлементЗапроса.guid, _список));
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ОбработатьEnterprise(пПараметры, пОтвет, пОшибка)
	
	Если НЕ ТипЗнч(пПараметры) = Тип("Массив") Тогда
		_Параметры = Новый Массив;
		_Параметры.Добавить(пПараметры);
	Иначе
		_Параметры = пПараметры;
	КонецЕсли;
	
	пОтвет.Вставить("Enterprise", Новый Массив);
	
	Для каждого _ЭлементЗапроса Из _Параметры Цикл
		
		Если НЕ ТипЗнч(_ЭлементЗапроса) = Тип("Структура") Тогда
			пОшибка = "Некорректные входные данные";
			Возврат Ложь;
		КонецЕсли;
		
		_Отказ = Ложь; _Ошибка = "";
		Если _ЭлементЗапроса.Свойство("businessEntityGuid") И ЗначениеЗаполнено(_ЭлементЗапроса.businessEntityGuid) Тогда
			_список = Новый Массив;
			_enterprise = Неопределено;
			_параметры = Неопределено;
			Пока ВетисEnterpriseService_2_0.GetActivityLocationListNext(_ЭлементЗапроса.businessEntityGuid, _enterprise, _параметры, _Отказ, _Ошибка) Цикл
				_список.Добавить(ПолучитьСтруктуруОбъекта(ВетисDictionaryСлой1с.Enterprise(_enterprise)));
			КонецЦикла;
			Если _Отказ = Истина Тогда
				Возврат Ложь;
			КонецЕсли;
			пОтвет.Enterprise.Добавить(Новый Структура("businessEntityGuid, Объекты", _ЭлементЗапроса.businessEntityGuid, _список));
			
		ИначеЕсли _ЭлементЗапроса.Свойство("guid") И ЗначениеЗаполнено(_ЭлементЗапроса.guid) Тогда
			_список = Новый Массив;
			_ссылка = ВетисDictionaryСлой1с.Enterprise(_ЭлементЗапроса.guid);
			_список.Добавить(ПолучитьСтруктуруОбъекта(_ссылка));
			пОтвет.Enterprise.Добавить(Новый Структура("guid, Объекты", _ЭлементЗапроса.guid, _список));
			
		Иначе
			_отбор = ВетисDictionary_2_0.Enterprise();
			Если _ЭлементЗапроса.Свойство("name") И ЗначениеЗаполнено(_ЭлементЗапроса.name) Тогда
				_отбор.name = _ЭлементЗапроса.name;
			КонецЕсли;
			Если _ЭлементЗапроса.Свойство("number") И ЗначениеЗаполнено(_ЭлементЗапроса.number) Тогда
				_отбор.numberList = ВетисDictionary_2_0.EnterpriseNumberList();
				_отбор.numberList.enterpriseNumber.Добавить(_ЭлементЗапроса.number);
			КонецЕсли;
			Если _ЭлементЗапроса.Свойство("country") И ЗначениеЗаполнено(_ЭлементЗапроса.country) Тогда
				_отбор.address = ВетисDictionary_2_0.Address();
				_отбор.address.country = ВетисDictionary_2_0.Country(_ЭлементЗапроса.country);
				Если _ЭлементЗапроса.Свойство("region") И ЗначениеЗаполнено(_ЭлементЗапроса.region) Тогда
					_отбор.address.region = ВетисDictionary_2_0.Region(_ЭлементЗапроса.region);
				КонецЕсли;
				Если _ЭлементЗапроса.Свойство("district") И ЗначениеЗаполнено(_ЭлементЗапроса.district) Тогда
					_отбор.address.district = ВетисDictionary_2_0.District(_ЭлементЗапроса.district);
				КонецЕсли;
				Если _ЭлементЗапроса.Свойство("locality") И ЗначениеЗаполнено(_ЭлементЗапроса.locality) Тогда
					_отбор.address.locality = ВетисDictionary_2_0.Locality(_ЭлементЗапроса.locality);
				КонецЕсли;
			КонецЕсли;
			_список = Новый Массив;
			_enterprise = Неопределено;
			_параметры = Неопределено;
			_макс = 1000;
			Пока ВетисEnterpriseService_2_0.GetRussianEnterpriseListNext(_отбор, _enterprise, _параметры) Цикл
				_список.Добавить(ПолучитьСтруктуруОбъекта(ВетисDictionaryСлой1с.Enterprise(_enterprise)));
				_макс = _макс - 1;
				Если _макс <= 0 Тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
			пОтвет.Enterprise.Добавить(Новый Структура("Объекты", _список));
			
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ОбработатьCountry(Country, пОтвет, пОшибка)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Таблица.Наименование КАК name,
	|	_Таблица.guid
	|ИЗ
	|	Справочник.ВетисCountry КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И НЕ _Таблица.ПометкаУдаления
	|//1	И _Таблица.Наименование подобно ""%<имя>%""
	|	И ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	Наименование");
	
	Если ЗначениеЗаполнено(Country) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//1", "");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "<имя>", Country);
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	пОтвет.Вставить("Country", Новый Массив);
	
	Пока Выборка.Следующий() Цикл
		пОтвет.Country.Добавить(Новый Структура("name,guid", Выборка.name, Выборка.guid));
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ОбработатьRegion(Region, пОтвет, пОшибка)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Таблица.Наименование КАК name,
	|	_Таблица.guid,
	|	_Таблица.Country.Наименование КАК CountryName,
	|	_Таблица.Country.guid КАК CountryGuid
	|ИЗ
	|	Справочник.ВетисRegion КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И НЕ _Таблица.ПометкаУдаления
	|//1	И _Таблица.Наименование подобно ""%<имя>%""
	|	И ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	Наименование");
	
	Если ЗначениеЗаполнено(Region) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//1", "");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "<имя>", Region);
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	пОтвет.Вставить("Region", Новый Массив);
	
	Пока Выборка.Следующий() Цикл
		_Объект = Новый Структура;
		_Объект.Вставить("name", Выборка.name);
		_Объект.Вставить("guid", Выборка.guid);
		_Объект.Вставить("Country", Новый Структура("name,guid", Выборка.CountryName, Выборка.CountryGuid));
		пОтвет.Region.Добавить(_Объект);
	КонецЦикла;
	
КонецФункции

Функция ОбработатьLocality(Locality, пОтвет, пОшибка)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Таблица.Наименование КАК name,
	|	_Таблица.guid,
	|	_Таблица.Country.Наименование КАК CountryName,
	|	_Таблица.Country.guid КАК CountryGuid,
	|	_Таблица.Region.Наименование КАК RegionName,
	|	_Таблица.Region.guid КАК RegionGuid,
	|	_Таблица.District.Наименование КАК DistrictName,
	|	_Таблица.District.guid КАК DistrictGuid
	|ИЗ
	|	Справочник.ВетисLocality КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И НЕ _Таблица.ПометкаУдаления
	|//1	И _Таблица.Наименование подобно ""%<имя>%""
	|	И ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	Наименование");
	
	Если ЗначениеЗаполнено(Locality) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//1", "");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "<имя>", Locality);
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	пОтвет.Вставить("Locality", Новый Массив);
	
	Пока Выборка.Следующий() Цикл
		_Объект = Новый Структура;
		_Объект.Вставить("name", Выборка.name);
		_Объект.Вставить("guid", Выборка.guid);
		_Объект.Вставить("Country", Новый Структура("name,guid", Выборка.CountryName, Выборка.CountryGuid));
		_Объект.Вставить("Region", Новый Структура("name,guid", Выборка.RegionName, Выборка.RegionGuid));
		_Объект.Вставить("District", Новый Структура("name,guid", Выборка.DistrictName, Выборка.DistrictGuid));
		пОтвет.Locality.Добавить(_Объект);
	КонецЦикла;
	
КонецФункции

Функция ОбработатьVetDocument(пПараметры, пОтвет, пОшибка = Ложь)
	
	Если НЕ (ТипЗнч(пПараметры) = Тип("Структура")) Тогда
		пОшибка = "Некорректные входные данные";
		Возврат Ложь;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"//оп2ВЫБРАТЬ
	|//оп2	_Таблица.Ссылка
	|//оп2 ПОМЕСТИТЬ ВПолучательПредприятие
	|//оп2ИЗ
	|//оп2	Справочник.ВетисEnterprise КАК _Таблица
	|//оп2ГДЕ
	|//оп2	ИСТИНА
	|//оп2	И (_Таблица.Ссылка.guid = &ПолучательПредприятие
	|//оп2	ИЛИ _Таблица.next.guid = &ПолучательПредприятие)
	|//оп2	И ИСТИНА
	|//оп2;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.uuid,
	|	_Таблица.Дата,
	|	_Таблица.Номер,
	|	_Таблица.НомерВеб,
	|	_Таблица.ДатаТТН,
	|	_Таблица.НомерТТН,
	|	_Таблица.Форма,
	|	_Таблица.Статус,
	|	_Таблица.Отправитель,
	|	_Таблица.Отправитель.guid КАК ОтправительGuid,
	|	_Таблица.Отправитель.Наименование КАК ОтправительНаименование,
	|	_Таблица.Отправитель.inn КАК ОтправительИНН,
	|	_Таблица.ОтправительПредприятие,
	|	_Таблица.ОтправительПредприятие.guid КАК ОтправительПредприятиеGuid,
	|	_Таблица.ОтправительПредприятие.last КАК ОтправительПредприятиеLast,
	|	_Таблица.ОтправительПредприятие.active КАК ОтправительПредприятиеActive,
	|	_Таблица.ОтправительПредприятие.Наименование КАК ОтправительПредприятиеНаименование,
	|	_Таблица.ОтправительПредприятие.addressView КАК ОтправительПредприятиеАдрес,
	|	_Таблица.ОтправительПредприятие.enterpriseNumber КАК ОтправительПредприятиеНомер,
	|	_Таблица.ОтправительПредприятие.next КАК ОтправительПредприятиеNext,
	|	_Таблица.ОтправительПредприятие.next.guid КАК ОтправительПредприятиеNextGuid,
	//|	_Таблица.ОтправительПредприятие.next.last КАК ОтправительПредприятиеNextLast,
	//|	_Таблица.ОтправительПредприятие.next.active КАК ОтправительПредприятиеNextActive,
	//|	_Таблица.ОтправительПредприятие.next.Наименование КАК ОтправительПредприятиеNextНаименование,
	//|	_Таблица.ОтправительПредприятие.next.addressView КАК ОтправительПредприятиеNextАдрес,
	//|	_Таблица.ОтправительПредприятие.next.enterpriseNumber КАК ОтправительПредприятиеNextНомер,
	|	_Таблица.Получатель,
	|	_Таблица.Получатель.guid КАК ПолучательGuid,
	|	_Таблица.Получатель.Наименование КАК ПолучательНаименование,
	|	_Таблица.Получатель.inn КАК ПолучательИНН,
	|	_Таблица.ПолучательПредприятие,
	|	_Таблица.ПолучательПредприятие.guid КАК ПолучательПредприятиеGuid,
	|	_Таблица.ПолучательПредприятие.last КАК ПолучательПредприятиеLast,
	|	_Таблица.ПолучательПредприятие.active КАК ПолучательПредприятиеActive,
	|	_Таблица.ПолучательПредприятие.Наименование КАК ПолучательПредприятиеНаименование,
	|	_Таблица.ПолучательПредприятие.addressView КАК ПолучательПредприятиеАдрес,
	|	_Таблица.ПолучательПредприятие.enterpriseNumber КАК ПолучательПредприятиеНомер,
	|	_Таблица.ПолучательПредприятие.next КАК ПолучательПредприятиеNext,
	|	_Таблица.ПолучательПредприятие.next.guid КАК ПолучательПредприятиеNextGuid,
	//|	_Таблица.ПолучательПредприятие.next.last КАК ПолучательПредприятиеNextLast,
	//|	_Таблица.ПолучательПредприятие.next.active КАК ПолучательПредприятиеNextActive,
	//|	_Таблица.ПолучательПредприятие.next.Наименование КАК ПолучательПредприятиеNextНаименование,
	//|	_Таблица.ПолучательПредприятие.next.addressView КАК ПолучательПредприятиеNextАдрес,
	//|	_Таблица.ПолучательПредприятие.next.enterpriseNumber КАК ПолучательПредприятиеNextНомер,
	|	_Таблица.ДатаВыработки,
	|	_Таблица.СрокГодности,
	|	_Таблица.СтранаПроисхождения,
	|	_Таблица.СтранаПроисхождения.guid КАК СтранаПроисхожденияGuid,
	|	_Таблица.СтранаПроисхождения.Наименование КАК СтранаПроисхожденияНаименование,
	//|	_Таблица.Производитель,
	//|	_Таблица.Производитель.guid КАК ПроизводительGuid,
	//|	_Таблица.Производитель.last КАК ПроизводительLast,
	//|	_Таблица.Производитель.active КАК ПроизводительActive,
	//|	_Таблица.Производитель.Наименование КАК ПроизводительНаименование,
	//|	_Таблица.Производитель.addressView КАК ПроизводительАдрес,
	//|	_Таблица.Производитель.enterpriseNumber КАК ПроизводительНомер,
	//|	_Таблица.Производитель.next КАК ПроизводительNext,
	//|	_Таблица.Производитель.next.guid КАК ПроизводительNextGuid,
	//|	_Таблица.Производитель.next.last КАК ПроизводительNextLast,
	//|	_Таблица.Производитель.next.active КАК ПроизводительNextActive,
	//|	_Таблица.Производитель.next.Наименование КАК ПроизводительNextНаименование,
	//|	_Таблица.Производитель.next.addressView КАК ПроизводительNextАдрес,
	//|	_Таблица.Производитель.next.enterpriseNumber КАК ПроизводительNextНомер,
	|	_Таблица.ProductItemName,
	|	_Таблица.Количество,
	|	_Таблица.Производители.(
	|		Предприятие,
	|		Предприятие.guid КАК ПредприятиеGuid,
	|		Предприятие.last КАК ПредприятиеLast,
	|		Предприятие.active КАК ПредприятиеActive,
	|		Предприятие.Наименование КАК ПредприятиеНаименование,
	|		Предприятие.addressView КАК ПредприятиеАдрес,
	|		Предприятие.enterpriseNumber КАК ПредприятиеНомер,
	|		Предприятие.next КАК ПредприятиеNext,
	|		Предприятие.next.guid КАК ПредприятиеNextGuid,
	|		Наименование КАК Наименование,
	|	) Производители
	|ИЗ
	|	Документ.ВетисВетеринарноСопроводительныйДокумент КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.Проведен
	|//о1	И _Таблица.Ссылка В (&Ссылка)
	|//ос	И _Таблица.Статус = &Статус
	|//оо1	И _Таблица.Отправитель.guid = &Отправитель
	|//оо2	И _Таблица.ОтправительПредприятие.guid = &ОтправительПредприятие
	|//оп1	И _Таблица.Получатель.guid = &Получатель
	|//оп2	И _Таблица.ПолучательПредприятие В (Выбрать Ссылка ИЗ ВПолучательПредприятие)
	|	И ИСТИНА");
	
	Если пПараметры.Свойство("Ссылка") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//о1", "");
		Запрос.УстановитьПараметр("Ссылка", пПараметры.Ссылка);
	КонецЕсли;
	
	Если пПараметры.Свойство("Статус") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ос", "");
		Запрос.УстановитьПараметр("Статус", ОбработатьСсылку(пПараметры.Статус));
	КонецЕсли;
	
	Если пПараметры.Свойство("Отправитель") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//оо1", "");
		Запрос.УстановитьПараметр("Отправитель", пПараметры.Отправитель);
	КонецЕсли;
	
	Если пПараметры.Свойство("ОтправительПредприятие") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//оо2", "");
		Запрос.УстановитьПараметр("ОтправительПредприятие", пПараметры.ОтправительПредприятие);
	КонецЕсли;
	
	Если пПараметры.Свойство("Получатель") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//оп1", "");
		Запрос.УстановитьПараметр("Получатель", пПараметры.Получатель);
	КонецЕсли;
	
	Если пПараметры.Свойство("ПолучательПредприятие") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//оп2", "");
		Запрос.УстановитьПараметр("ПолучательПредприятие", пПараметры.ПолучательПредприятие);
	КонецЕсли;
	
	//Попытка
	Результат = Запрос.Выполнить();
	//Исключение
	//_=ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	//КонецПопытки;
	Выборка = Результат.Выбрать();
	
	пОтвет.Вставить("VetDocument", Новый Массив);
	
	_be = Метаданные.Справочники.ВетисBusinessEntity.ПолноеИмя();
	_en = Метаданные.Справочники.ВетисEnterprise.ПолноеИмя();
	_cn = Метаданные.Справочники.ВетисCountry.ПолноеИмя();
	
	Пока Выборка.Следующий() Цикл
		_Объект = Новый Структура;
		_Объект.Вставить("Тип", Метаданные.Документы.ВетисВетеринарноСопроводительныйДокумент.ПолноеИмя());
		_Объект.Вставить("ref", Выборка.uuid);
		_Объект.Вставить("uuid", Выборка.uuid);
		_Объект.Вставить("Дата", Выборка.Дата);
		_Объект.Вставить("Номер", Выборка.Номер);
		_Объект.Вставить("НомерВеб", Выборка.НомерВеб);
		_Объект.Вставить("ДатаТТН", Выборка.ДатаТТН);
		_Объект.Вставить("НомерТТН", Выборка.НомерТТН);
		_Объект.Вставить("Форма", ПолучитьСтруктуруОбъекта(Выборка.Форма));
		_Объект.Вставить("Статус", ПолучитьСтруктуруОбъекта(Выборка.Статус));
		_Объект.Вставить("Отправитель", Новый Структура("Тип,ref,guid, Наименование, inn", _be, Выборка.ОтправительGuid, Выборка.ОтправительGuid, Выборка.ОтправительНаименование, Выборка.ОтправительИНН));
		_Объект.Вставить("Получатель", Новый Структура("Тип,ref,guid, Наименование, inn", _be, Выборка.ПолучательGuid, Выборка.ПолучательGuid, Выборка.ПолучательНаименование, Выборка.ПолучательИНН));
		_Объект.Вставить("ОтправительПредприятие", Новый Структура("Тип,ref,guid, last, active, Наименование, addressView, enterpriseNumber", _en, Выборка.ОтправительПредприятиеGuid, Выборка.ОтправительПредприятиеGuid, Выборка.ОтправительПредприятиеLast, Выборка.ОтправительПредприятиеActive, Выборка.ОтправительПредприятиеНаименование, Выборка.ОтправительПредприятиеАдрес, Выборка.ОтправительПредприятиеНомер));
		_Объект.Вставить("ПолучательПредприятие", Новый Структура("Тип,ref,guid, last, active, Наименование, addressView, enterpriseNumber", _en, Выборка.ПолучательПредприятиеGuid, Выборка.ПолучательПредприятиеGuid, Выборка.ПолучательПредприятиеLast, Выборка.ПолучательПредприятиеActive, Выборка.ПолучательПредприятиеНаименование, Выборка.ПолучательПредприятиеАдрес, Выборка.ПолучательПредприятиеНомер));
		Если ЗначениеЗаполнено(Выборка.ОтправительПредприятиеNext) Тогда
			_Объект.ОтправительПредприятие.Вставить("next", Новый Структура("Тип,ref,guid", _en, Выборка.ОтправительПредприятиеNextGuid, Выборка.ОтправительПредприятиеNextGuid));
		КонецЕсли;
		Если ЗначениеЗаполнено(Выборка.ПолучательПредприятиеNext) Тогда
			_Объект.ПолучательПредприятие.Вставить("next", Новый Структура("Тип,ref,guid", _en, Выборка.ПолучательПредприятиеNextGuid, Выборка.ПолучательПредприятиеNextGuid));
		КонецЕсли;
		_Объект.Вставить("Производители", Новый Массив);
		
		ВыборкаПр = Выборка.Производители.Выбрать();
		Пока ВыборкаПр.Следующий() Цикл
			Если ЗначениеЗаполнено(ВыборкаПр.Предприятие) Тогда
				_Предприятие = Новый Структура("Тип,ref,guid, last, active, Наименование, addressView, enterpriseNumber", _en, ВыборкаПр.ПредприятиеGuid, ВыборкаПр.ПредприятиеGuid, ВыборкаПр.ПредприятиеLast, ВыборкаПр.ПредприятиеActive, ВыборкаПр.ПредприятиеНаименование, ВыборкаПр.ПредприятиеАдрес, ВыборкаПр.ПредприятиеНомер);
				Если ЗначениеЗаполнено(ВыборкаПр.ПредприятиеNext) Тогда
					_Предприятие.Вставить("next", Новый Структура("Тип,ref,guid", _en, ВыборкаПр.ПредприятиеNextGuid, ВыборкаПр.ПредприятиеNextGuid));
				КонецЕсли;
			Иначе
				_Предприятие = Новый Структура;
			КонецЕсли;
			_Объект.Производители.Добавить(Новый Структура("Предприятие, Наименование", _Предприятие, ВыборкаПр.Наименование));
		КонецЦикла;
		
		Если ЗначениеЗаполнено(Выборка.СтранаПроисхождения) Тогда
			_Объект.Вставить("СтранаПроисхождения", Новый Структура("Тип,ref,guid, Наименование", _cn, Выборка.СтранаПроисхожденияGuid, Выборка.СтранаПроисхожденияGuid, Выборка.СтранаПроисхожденияНаименование));
		КонецЕсли;
		_Объект.Вставить("ДатаВыработки", Выборка.ДатаВыработки);
		_Объект.Вставить("СрокГодности", Выборка.СрокГодности);
		_Объект.Вставить("ProductItemName", Выборка.ProductItemName);
		_Объект.Вставить("Количество", Выборка.Количество);
		пОтвет.VetDocument.Добавить(_Объект);
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ОбработатьStockEntry(пПараметры, пОтвет, пОшибка = Ложь)
	
	Если НЕ (ТипЗнч(пПараметры) = Тип("Структура")) Тогда
		пОшибка = "Некорректные входные данные";
		Возврат Ложь;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Таблица.guid,
	|	_Таблица.Код entryNumber,
	|	_Таблица.last,
	|	_Таблица.active,
	|	_Таблица.createDate,
	|	_Таблица.updateDate,
	|	_Таблица.BusinessEntity,
	|	_Таблица.BusinessEntity.guid КАК BusinessEntityGuid,
	|	_Таблица.BusinessEntity.Наименование КАК BusinessEntityName,
	|	_Таблица.BusinessEntity.inn КАК BusinessEntityINN,
	|	_Таблица.Enterprise,
	|	_Таблица.Enterprise.guid КАК EnterpriseGuid,
	|	_Таблица.Enterprise.last КАК EnterpriseLast,
	|	_Таблица.Enterprise.active КАК EnterpriseActive,
	|	_Таблица.Enterprise.Наименование КАК EnterpriseName,
	|	_Таблица.Enterprise.addressView КАК EnterpriseAddress,
	|	_Таблица.Enterprise.enterpriseNumber КАК EnterpriseNumber,
	|	_Таблица.Enterprise.next КАК EnterpriseNext,
	|	_Таблица.Enterprise.next.guid КАК EnterpriseNextGuid,
	|	_Таблица.volume,
	|	_Таблица.packingAmount,
	|	_Таблица.productMarking,
	|	_Таблица.ProductItemName,
	//|	_Таблица.producer,
	//|	_Таблица.producer.guid КАК producerGuid,
	//|	_Таблица.producer.last КАК producerLast,
	//|	_Таблица.producer.active КАК producerActive,
	//|	_Таблица.producer.Наименование КАК producerName,
	//|	_Таблица.producer.addressView КАК producerAddress,
	//|	_Таблица.producer.enterpriseNumber КАК producerNumber,
	//|	_Таблица.producer.next КАК producerNext,
	//|	_Таблица.producer.next.guid КАК producerNextGuid,
	|	_Таблица.producerName КАК producerName,
	|	_Таблица.country,
	|	_Таблица.country.guid КАК countryGuid,
	|	_Таблица.country.Наименование КАК countryName,
	//|	_Таблица.vetDocument,
	//|	_Таблица.vetDocument.uuid КАК vetDocumentUuid,
	|	_Таблица.dateOfProduction,
	|	_Таблица.expiryDate
	|ИЗ
	|	Справочник.ВетисStockEntry КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.last
	|	И _Таблица.active
	|	И _Таблица.volume > 0
	|	И НЕ _Таблица.status = Значение(Перечисление.ВетисVersionStatus.WITHDRAWN)
	|//о1	И _Таблица.BusinessEntity.guid = &BusinessEntity
	|//о2	И _Таблица.Enterprise.guid = &Enterprise
	|//о3	И _Таблица.Ссылка В (&Ссылка)
	|	И ИСТИНА");
	
	Если пПараметры.Свойство("Ссылка") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//о3", "");
		Запрос.УстановитьПараметр("Ссылка", пПараметры.Ссылка);
	КонецЕсли;
	
	Если пПараметры.Свойство("ХС") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//о1", "");
		Запрос.УстановитьПараметр("BusinessEntity", пПараметры.ХС);
	КонецЕсли;
	
	Если пПараметры.Свойство("Предприятие") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//о2", "");
		Запрос.УстановитьПараметр("Enterprise", пПараметры.Предприятие);
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_be = Метаданные.Справочники.ВетисBusinessEntity.ПолноеИмя();
	_en = Метаданные.Справочники.ВетисEnterprise.ПолноеИмя();
	_cn = Метаданные.Справочники.ВетисCountry.ПолноеИмя();
	
	пОтвет.Вставить("StockEntry", Новый Массив);
	
	Пока Выборка.Следующий() Цикл
		_Объект = Новый Структура;
		_Объект.Вставить("Тип", Метаданные.Справочники.ВетисStockEntry.ПолноеИмя());
		_Объект.Вставить("ref", Выборка.guid);
		_Объект.Вставить("guid", Выборка.guid);
		_Объект.Вставить("entryNumber", Выборка.entryNumber);
		_Объект.Вставить("last", Выборка.last);
		_Объект.Вставить("active", Выборка.active);
		_Объект.Вставить("createDate", Выборка.createDate);
		_Объект.Вставить("updateDate", Выборка.updateDate);
		_Объект.Вставить("BusinessEntity", Новый Структура("Тип,ref,guid, Наименование, inn", _be, Выборка.BusinessEntityGuid, Выборка.BusinessEntityGuid, Выборка.BusinessEntityName, Выборка.BusinessEntityINN));
		_Объект.Вставить("Enterprise", Новый Структура("Тип,ref,guid, last, active, Наименование, addressView, enterpriseNumber", _en, Выборка.EnterpriseGuid, Выборка.EnterpriseGuid, Выборка.EnterpriseLast, Выборка.EnterpriseActive, Выборка.EnterpriseName, Выборка.EnterpriseAddress, Выборка.EnterpriseNumber));
		Если ЗначениеЗаполнено(Выборка.EnterpriseNext) Тогда
			//_Объект.Enterprise.Вставить("next", Новый Структура("guid, last, active, Наименование, addressView, enterpriseNumber", Выборка.EnterpriseNextGuid, Выборка.EnterpriseNextLast, Выборка.EnterpriseNextActive, Выборка.EnterpriseNextНаименование, Выборка.EnterpriseNextАдрес, Выборка.EnterpriseNextНомер));
			_Объект.Enterprise.Вставить("next", Новый Структура("Тип,ref,guid", _en, Выборка.EnterpriseNextGuid, Выборка.EnterpriseNextGuid));
		КонецЕсли;
		_Объект.Вставить("ProductItemName", Выборка.ProductItemName);
		_Объект.Вставить("volume", Выборка.volume);
		_Объект.Вставить("packingAmount", Выборка.packingAmount);
		_Объект.Вставить("productMarking", Выборка.productMarking);
		//Если ЗначениеЗаполнено(Выборка.producer) Тогда
		//	_Объект.Вставить("producer", Новый Структура("guid, last, active, Наименование, addressView, enterpriseNumber", Выборка.producerGuid, Выборка.producerLast, Выборка.producerActive, Выборка.producerName, Выборка.producerAddress, Выборка.producerNumber));
		//	Если ЗначениеЗаполнено(Выборка.producerNext) Тогда
		//		//_Объект.producer.Вставить("next", Новый Структура("guid, last, active, Наименование, addressView, enterpriseNumber", Выборка.producerNextGuid, Выборка.producerNextLast, Выборка.producerNextActive, Выборка.producerNextНаименование, Выборка.producerNextАдрес, Выборка.producerNextНомер));
		//		_Объект.producer.Вставить("next", Новый Структура("guid", Выборка.producerNextGuid));
		//	КонецЕсли;
		//КонецЕсли;
		_Объект.Вставить("producerName", Выборка.producerName);
		Если ЗначениеЗаполнено(Выборка.country) Тогда
			_Объект.Вставить("country", Новый Структура("Тип,ref,guid, Наименование", _cn, Выборка.countryGuid, Выборка.countryGuid, Выборка.countryName));
		КонецЕсли;
		//Если ЗначениеЗаполнено(Выборка.vetDocument) Тогда
		//	_Объект.Вставить("vetDocument", Новый Структура("uuid", Выборка.vetDocumentUuid));
		//КонецЕсли;
		
		_Объект.Вставить("dateOfProduction", Выборка.dateOfProduction);
		_Объект.Вставить("expiryDate", Выборка.expiryDate);
		
		пОтвет.StockEntry.Добавить(_Объект);
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции


Функция ВыбратьИзменения(пНомерОтправленного)
	
	_Узел = ПланыОбмена.ВетисКлиенты.ПолучитьУзел();
	
	пНомерОтправленного = _Узел.НомерОтправленного+1;
	
	_объекты = Новый Массив;
	
	_Выборка = ПланыОбмена.ВыбратьИзменения(_Узел, пНомерОтправленного);
	
	_Выгруженные = Неопределено;
	Пока _Выборка.Следующий() Цикл
		
		_Данные = _Выборка.Получить();
		
		_объекты.Добавить(ПолучитьСтруктуруОбъекта(_Данные));
		
	КонецЦикла;
	
	Возврат _объекты;
	
КонецФункции



Функция ОтветСервер(пСообщение, пОтказ = Ложь, пГотово = Ложь, пОтвет = Неопределено)
	
	_Ответ = Новый Структура("Готово,Отказ,Сообщение,Ответ", пГотово, пОтказ, пСообщение, пОтвет);
	
	_Ответ = Новый ХранилищеЗначения(_Ответ, Новый СжатиеДанных(9));
	
	Возврат Сериализовать(_Ответ);
	
КонецФункции


Функция Сериализовать(пОбъект) Экспорт
	
	_ЗаписьXML = Новый ЗаписьXML;
	_ЗаписьXML.УстановитьСтроку("UTF-8");
	
	ЗаписатьXML(_ЗаписьXML, пОбъект);
	
	Возврат _ЗаписьXML.Закрыть();
	
КонецФункции

Функция Десериализовать(пТекст) Экспорт
	
	_Чтение = Новый ЧтениеXML;
	
	_Чтение.УстановитьСтроку(пТекст);
	
	_Результат = ПрочитатьXML(_Чтение);
	
	_Чтение.Закрыть();
	
	Возврат _Результат;
	
КонецФункции

Функция ПолучитьСтруктуруОбъекта(пОбъект, пВыгруженные = Неопределено, пПодробно = Истина, пПодробноПоСсылке = Истина)
	
	Возврат ВетисОбщегоНазначения.ПолучитьСтруктуруОбъектаДляОбмена(пОбъект, пВыгруженные, пПодробно, пПодробноПоСсылке)
	
КонецФункции


Функция ОбработатьСсылку(пОбъект, пОшибка = "", пОбновление = Ложь, пОбменДаннымиЗагрузка = Истина, пУдаление = Ложь) Экспорт
	
	Если НЕ ТипЗнч(пОбъект) = Тип("Структура") Тогда
		пОшибка = "Некорректные входные данные 1";
		Возврат Неопределено;
	КонецЕсли;
	
	_Ссылка = Неопределено;
	
	Если НЕ пОбъект.Свойство("Тип") Тогда
		пОшибка = "Некорректные входные данные 1";
		Возврат Неопределено;
	ИначеЕсли пОбъект.Тип = "УдалениеОбъекта" Тогда
		Возврат ОбработатьСсылку(пОбъект.Объект, пОшибка, пОбновление, пОбменДаннымиЗагрузка, Истина);
	КонецЕсли;
	
	_менеджер = МенеджерПоИмени(пОбъект.Тип, пОшибка);
	
	Если НЕ пОшибка = "" Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если _менеджер.Тип = Документы Тогда
		_Ссылка = ЗаполнитьДокумент(_менеджер.менеджер, пОбъект, пОшибка, пОбновление, пОбменДаннымиЗагрузка, пУдаление);
	ИначеЕсли _менеджер.Тип = Справочники Тогда
		_Ссылка = ЗаполнитьСправочник(_менеджер.менеджер, пОбъект, пОшибка, пОбновление, пОбменДаннымиЗагрузка, пУдаление);
	ИначеЕсли _менеджер.Тип = Перечисления Тогда
		Если НЕ пОбъект.Свойство("Имя") Тогда
			пОшибка = "Некорректные входные данные 2";
			Возврат Неопределено;
		ИначеЕсли пОбъект.Имя = "" Тогда
			_Ссылка = _менеджер.менеджер.ПустаяСсылка();
		Иначе
			_Ссылка = _менеджер.менеджер[пОбъект.Имя];
		КонецЕсли;
	ИначеЕсли _менеджер.Тип = РегистрыСведений Тогда
		_Ссылка = ЗаполнитьРегистрСведений(_менеджер, пОбъект, пОшибка, пОбновление, пОбменДаннымиЗагрузка, пУдаление);
	ИначеЕсли _менеджер.Тип = РегистрыНакопления Тогда
		_Ссылка = ЗаполнитьРегистрНакопления(_менеджер, пОбъект, пОшибка, пОбновление, пОбменДаннымиЗагрузка, пУдаление);
	КонецЕсли;
	
	Возврат _Ссылка;
	
КонецФункции

Функция ЗаполнитьСправочник(пМенеджер, пОбъект, пОшибка = "", пОбновление = Ложь, пОбменДаннымиЗагрузка = Истина, пУдаление = Ложь)
	
	_менеджер = пМенеджер;
	
	Если НЕ пОбъект.Свойство("ref") Тогда
		Возврат _менеджер.ПустаяСсылка();
	КонецЕсли;
	
	Если пОбъект.ref = "00000000-0000-0000-0000-000000000000" Тогда
		Возврат _менеджер.ПустаяСсылка();
	КонецЕсли;
	
	Если пОбъект.Свойство("guid") Тогда
		_ref = Новый УникальныйИдентификатор(пОбъект.guid);
	Иначе
		_ref = Новый УникальныйИдентификатор(пОбъект.ref);
	КонецЕсли;
	
	_Ссылка = _менеджер.ПолучитьСсылку(_ref);
	
	_Объект = _Ссылка.ПолучитьОбъект();
	
	//если количество больше 2, считаем что объект передан полностью и возможно его обновление
	_Обновление = _Объект = Неопределено ИЛИ пОбновление = Истина И пОбъект.Количество()>2;
	
	Если _Обновление И ПравоДоступа("Изменение",_менеджер.ПустаяСсылка().Метаданные()) Тогда
		Если _Объект = Неопределено Тогда
			_Объект = _менеджер.СоздатьЭлемент();
			_Объект.УстановитьСсылкуНового(_Ссылка);
		КонецЕсли;
		_Объект.ОбменДанными.Загрузка = пОбменДаннымиЗагрузка;
		УстановитьЗначение(_Объект, пОбъект, "Код");
		УстановитьЗначение(_Объект, пОбъект, "Наименование");
		УстановитьЗначение(_Объект, пОбъект, "ПометкаУдаления");
		Попытка
			_Объект.Записать();
		Исключение
			пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			Возврат Неопределено;
		КонецПопытки;
	КонецЕсли;
	
	Возврат _Ссылка;
	
КонецФункции

Функция ЗаполнитьДокумент(пМенеджер, пОбъект, пОшибка = "", пОбновление = Ложь, пОбменДаннымиЗагрузка = Истина, пУдаление = Ложь)
	
	Если НЕ пОбъект.Свойство("ref") Тогда
		пОшибка = "Некорректные входные данные";
		Возврат Неопределено;
	КонецЕсли;
	
	_менеджер = пМенеджер;
	
	//Если НЕ пОбъект.Свойство("guid") Тогда
	//	//пОшибка = "Некорректные входные данные";
	//	//Возврат Неопределено;
	//	Возврат _менеджер.ПустаяСсылка();
	//КонецЕсли;
	
	Если пОбъект.ref = "00000000-0000-0000-0000-000000000000" Тогда
		Возврат _менеджер.ПустаяСсылка();
	КонецЕсли;
	
	_Метаданные = _менеджер.ПустаяСсылка().Метаданные();
	
	_ref = Новый УникальныйИдентификатор(пОбъект.ref);
	
	_Ссылка = _менеджер.ПолучитьСсылку(_ref);
	
	_Объект = _Ссылка.ПолучитьОбъект();
	
	//если количество больше 2, считаем что объект передан полностью и возможно его обновление
	_Обновление = _Объект = Неопределено ИЛИ пОбновление = Истина И пОбъект.Количество()>2;
	
	Если _Обновление И ПравоДоступа("Изменение", _Метаданные) Тогда
		Если _Объект = Неопределено Тогда
			_Объект = _менеджер.СоздатьДокумент();
			_Объект.УстановитьСсылкуНового(_Ссылка);
		КонецЕсли;
		_Объект.ОбменДанными.Загрузка = пОбменДаннымиЗагрузка;
		УстановитьЗначение(_Объект, пОбъект, "Дата");
		УстановитьЗначение(_Объект, пОбъект, "Номер");
		УстановитьЗначение(_Объект, пОбъект, "Проведен");
		УстановитьЗначение(_Объект, пОбъект, "ПометкаУдаления");
		
		ЗаполнитьРеквизиты(_Метаданные.Реквизиты, _Объект, пОбъект);
		
		Для каждого _МетаданныеТЧ Из _Метаданные.ТабличныеЧасти Цикл
			Если пОбъект.Свойство(_МетаданныеТЧ.Имя) Тогда
				_ТЧ = _Объект[_МетаданныеТЧ.Имя];
				_ТЧ.Очистить();
				Для каждого _ИсточникСтрокаТЧ Из пОбъект[_МетаданныеТЧ.Имя] Цикл
					ЗаполнитьРеквизиты(_МетаданныеТЧ.Реквизиты, _ТЧ.Добавить(), _ИсточникСтрокаТЧ);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
		
		Попытка
			_Объект.Записать();
		Исключение
			пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			Возврат Неопределено;
		КонецПопытки;
	КонецЕсли;
	
	Возврат _Ссылка;
	
КонецФункции

Функция ЗаполнитьРегистрСведений(пМенеджер, пОбъект, пОшибка = "", пОбновление = Ложь, пОбменДаннымиЗагрузка = Истина, пУдаление = Ложь)
	
	Если НЕ пОбъект.Свойство("Записи") Тогда
		пОшибка = "Некорректные входные данные 4";
		Возврат Неопределено;
	КонецЕсли;
	
	_менеджер = пМенеджер.менеджер;
	
	_Объект = _менеджер.СоздатьНаборЗаписей();
	
	_Обновление = пОбновление = Истина;
	
	Если _Обновление И ПравоДоступа("Изменение",пМенеджер.Метаданные) Тогда
		_Объект.ОбменДанными.Загрузка = пОбменДаннымиЗагрузка;
		
		Если Ложь Тогда
		//Если _менеджер = РегистрыСведений.КомплектацияКонтейнеровОстатки Тогда
		//	Для каждого _Запись Из пОбъект.Записи Цикл
		//		_ОбъектЗапись = _Объект.Добавить();
		//		Если _Запись.Свойство("Контейнер") Тогда
		//			_ОбъектЗапись.Контейнер = ОбработатьСсылку(_Запись.Контейнер, пОшибка, _Обновление);
		//			Если НЕ пОшибка = "" Тогда
		//				Возврат Неопределено;
		//			КонецЕсли;
		//		КонецЕсли;
		//		Если _Запись.Свойство("Коробка") Тогда
		//			_ОбъектЗапись.Коробка = ОбработатьСсылку(_Запись.Коробка, пОшибка, _Обновление);
		//			Если НЕ пОшибка = "" Тогда
		//				Возврат Неопределено;
		//			КонецЕсли;
		//		КонецЕсли;
		//		УстановитьЗначение(_ОбъектЗапись, _Запись, "Порядок");
		//		УстановитьЗначение(_ОбъектЗапись, _Запись, "Количество");
		//		УстановитьЗначение(_ОбъектЗапись, _Запись, "КоличествоМест");
		//	КонецЦикла;
		//ИначеЕсли _менеджер = РегистрыСведений.РазмещениеКонтейнеровОстатки Тогда
		//	Для каждого _Запись Из пОбъект.Записи Цикл
		//		_ОбъектЗапись = _Объект.Добавить();
		//		Если _Запись.Свойство("Размещение") Тогда
		//			_ОбъектЗапись.Размещение = ОбработатьСсылку(_Запись.Размещение, пОшибка, _Обновление);
		//			Если НЕ пОшибка = "" Тогда
		//				Возврат Неопределено;
		//			КонецЕсли;
		//		КонецЕсли;
		//		Если _Запись.Свойство("Контейнер") Тогда
		//			_ОбъектЗапись.Контейнер = ОбработатьСсылку(_Запись.Контейнер, пОшибка, _Обновление);
		//			Если НЕ пОшибка = "" Тогда
		//				Возврат Неопределено;
		//			КонецЕсли;
		//		КонецЕсли;
		//		УстановитьЗначение(_ОбъектЗапись, _Запись, "Порядок");
		//		УстановитьЗначение(_ОбъектЗапись, _Запись, "Количество");
		//		УстановитьЗначение(_ОбъектЗапись, _Запись, "КоличествоМест");
		//	КонецЦикла;
		Иначе
			//Возврат;
		КонецЕсли;
		
		Попытка
			_Объект.Записать();
		Исключение
			пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			Возврат Неопределено;
		КонецПопытки;
	КонецЕсли;
	
	Возврат _Объект;
	
КонецФункции

Функция ЗаполнитьРегистрНакопления(пМенеджер, пОбъект, пОшибка = "", пОбновление = Ложь, пОбменДаннымиЗагрузка = Истина, пУдаление = Ложь)
	
	#Если НЕ МобильноеПриложениеСервер Тогда
		Возврат Неопределено;
	#КонецЕсли
	
	Если НЕ пОбъект.Свойство("Записи") Тогда
		пОшибка = "Некорректные входные данные 4";
		Возврат Неопределено;
	КонецЕсли;
	
	_менеджер = пМенеджер.менеджер;
	
	_Объект = _менеджер.СоздатьНаборЗаписей();
	
	//_Обновление = пОбновление = Истина;
	//
	//Если _Обновление И ПравоДоступа("Изменение",пМенеджер.Метаданные) Тогда
	//	_Объект.ОбменДанными.Загрузка = пОбменДаннымиЗагрузка;
	//	
	//	Попытка
	//		_Объект.Записать();
	//	Исключение
	//		пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	//		Возврат Неопределено;
	//	КонецПопытки;
	//КонецЕсли;
	
	Возврат _Объект;
	
КонецФункции

Функция МенеджерПоИмени(пИмя, пОшибка = "") Экспорт
	
	_Метаданные = Метаданные.НайтиПоПолномуИмени(пИмя);
	
	Если _Метаданные = Неопределено Тогда
		Возврат Неопределено;
	ИначеЕсли Метаданные.Справочники.Содержит(_Метаданные) Тогда
		_ТипМетаданных = Справочники;
		_менеджер = Справочники[_Метаданные.Имя];
	ИначеЕсли Метаданные.Документы.Содержит(_Метаданные) Тогда
		_ТипМетаданных = Документы;
		_менеджер = Документы[_Метаданные.Имя];
	ИначеЕсли Метаданные.Перечисления.Содержит(_Метаданные) Тогда
		_ТипМетаданных = Перечисления;
		_менеджер = Перечисления[_Метаданные.Имя];
	ИначеЕсли Метаданные.РегистрыСведений.Содержит(_Метаданные) Тогда
		_ТипМетаданных = РегистрыСведений;
		_менеджер = РегистрыСведений[_Метаданные.Имя];
	ИначеЕсли Метаданные.РегистрыНакопления.Содержит(_Метаданные) Тогда
		_ТипМетаданных = РегистрыНакопления;
		_менеджер = РегистрыНакопления[_Метаданные.Имя];
	Иначе
		пОшибка = "Некорректные входные данные 3 " + пИмя;
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат Новый Структура("Менеджер, Тип, Метаданные", _менеджер, _ТипМетаданных, _метаданные);
	
КонецФункции

Процедура УстановитьЗначение(пПриемник, пИсточник, пИмяСвойства)
	
	Если пИсточник.Свойство(пИмяСвойства) Тогда
		_Источник = пИсточник[пИмяСвойства];
		Если ТипЗнч(_Источник) = Тип("Структура") Тогда
			Если _Источник.Свойство("Тип") Тогда
				Если _Источник.Тип = "Дата" Тогда
					_Источник = Дата(_Источник.Значение);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		пПриемник[пИмяСвойства] = _Источник;
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьЗначениеСсылки(пПриемник, пИсточник, пИмяСвойства, пОшибка, пОбновление)
	
	Если пИсточник.Свойство(пИмяСвойства) Тогда
		пПриемник[пИмяСвойства] = ОбработатьСсылку(пИсточник[пИмяСвойства], пОшибка, пОбновление);
	КонецЕсли;
	
КонецПроцедуры

Функция ЗаполнитьРеквизиты(пМетаданныеКоллекция, пОбъект, пИсточник, пОшибка = "")
	
	Для каждого _Реквизит Из пМетаданныеКоллекция Цикл
		_Значение = Неопределено;
		Если пИсточник.Свойство(_Реквизит.Имя, _Значение) Тогда
			Если ТипЗнч(_Значение) = Тип("Структура") Тогда
				_Значение = ОбработатьСсылку(_Значение, пОшибка);
				Если _Значение = Неопределено Тогда
					Возврат Ложь;
				Иначе
					пОбъект[_Реквизит.Имя] = _Значение;
				КонецЕсли;
			Иначе
				пОбъект[_Реквизит.Имя] = _Значение;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция МенеджерПоСсылке(пСсылка, пОшибка = "") Экспорт
	
	_Метаданные = пСсылка.Метаданные();
	
	Если Метаданные.Справочники.Содержит(_Метаданные) Тогда
		_ТипМетаданных = Справочники;
		_менеджер = Справочники[_Метаданные.Имя];
	ИначеЕсли Метаданные.Документы.Содержит(_Метаданные) Тогда
		_ТипМетаданных = Документы;
		_менеджер = Документы[_Метаданные.Имя];
	ИначеЕсли Метаданные.Перечисления.Содержит(_Метаданные) Тогда
		_ТипМетаданных = Перечисления;
		_менеджер = Перечисления[_Метаданные.Имя];
	ИначеЕсли Метаданные.РегистрыСведений.Содержит(_Метаданные) Тогда
		_ТипМетаданных = РегистрыСведений;
		_менеджер = РегистрыСведений[_Метаданные.Имя];
	ИначеЕсли Метаданные.РегистрыНакопления.Содержит(_Метаданные) Тогда
		_ТипМетаданных = РегистрыНакопления;
		_менеджер = РегистрыНакопления[_Метаданные.Имя];
	Иначе
		//пОшибка = "Некорректные входные данные 3 " + пИмя;
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат _менеджер;
	
КонецФункции
