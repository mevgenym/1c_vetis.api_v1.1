
&НаКлиенте
Процедура ХозяйствующийСубъектПриИзменении(Элемент)
	
	Объект.Предприятие = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтчетВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ПоказатьВводСтроки(, Элементы.Отчет.ТекущиеДанные.Результат,,,Истина);
	
КонецПроцедуры


&НаКлиенте
Процедура КомандаЗапуск(Команда)
	КомандаЗапускНаСервере();
КонецПроцедуры

&НаСервере
Процедура КомандаЗапускНаСервере()
	
	Перем _Item, _параметры, _ДатаНачала;
	
	_Версия20 = Ветис.Версия_2_0();
	
	Отчет.Очистить();
	
	Если _Версия20 Тогда
		
		_businessEntityGuid = ВетисDictionaryСлой1с.BusinessEntity(Объект.ХозяйствующийСубъект);
		_enterpriseGuid     = ВетисDictionaryСлой1с.Enterprise(Объект.Предприятие);
		
		_businessEntity = ВетисDictionary.BusinessEntity(ВетисDictionaryСлой1с.BusinessEntity(Объект.ХозяйствующийСубъект));
		_enterprise     = ВетисDictionary.Enterprise(ВетисDictionaryСлой1с.Enterprise(Объект.Предприятие));
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		_Отказ = Ложь;
		_Ошибка = "";
		_Item = Неопределено;
		_параметры = Неопределено;
		_ДатаНачала = Дата(1,1,1);
		
		Попытка
			Пока ВетисMercuryApplications.GetStockEntryChangesListNext(_enterpriseGuid, _ДатаНачала, , _businessEntityGuid, _Item, _параметры, _Отказ, _Ошибка) Цикл
				Если _Отказ = Истина Тогда
					Прервать; 
				КонецЕсли;
			КонецЦикла;
			
			ОтчетДополнить("GetStockEntryChangesList", ?(_Отказ, _Ошибка, "Ок (total:"+_параметры.ListResponse.total+")"));
		Исключение
			ОтчетДополнить("GetStockEntryChangesList", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		_Отказ = Ложь;
		_Ошибка = "";
		_Item = Неопределено;
		_параметры = Новый Структура("searchPattern", ВетисКонстанты.StockEntryBlankFilter_NOT_BLANK());
		
		Попытка
			Пока ВетисMercuryApplications.GetStockEntryListNext(_enterpriseGuid, _businessEntityGuid, _Item, _параметры, _Отказ, _Ошибка) Цикл
				Если _Отказ = Истина Тогда
					Прервать; 
				КонецЕсли;
			КонецЦикла;
			
			ОтчетДополнить("GetStockEntryList", ?(_Отказ, _Ошибка, "Ок (total:"+_параметры.ListResponse.total+")"));
		Исключение
			ОтчетДополнить("GetStockEntryList", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		_Отказ = Ложь;
		_Ошибка = "";
		_Item = Неопределено;
		_параметры = Неопределено;
		_ДатаНачала = ДобавитьМесяц(ТекущаяДатаСеанса(), -12);
		
		Попытка
			Пока ВетисMercuryApplications.GetVetDocumentChangesListNext(_enterpriseGuid, _ДатаНачала, , _businessEntityGuid, _Item, _параметры, _Отказ, _Ошибка) Цикл
				Если _Отказ = Истина Тогда
					Прервать; 
				КонецЕсли;
			КонецЦикла;
			
			ОтчетДополнить("GetVetDocumentChangesList", ?(_Отказ, _Ошибка, "Ок (total:"+_параметры.ListResponse.total+")"));
		Исключение
			ОтчетДополнить("GetVetDocumentChangesList", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		_Отказ = Ложь;
		_Ошибка = "";
		_Item = Неопределено;
		_параметры = Неопределено;
		
		Попытка
			Пока ВетисMercuryApplications.GetVetDocumentListNext(_enterpriseGuid, _businessEntityGuid, ВетисКонстанты.VetDocumentType_INCOMING(), ВетисКонстанты.VetDocumentStatus_CONFIRMED(), _Item, _параметры, _Отказ, _Ошибка) Цикл
				Если _Отказ = Истина Тогда
					Прервать;
				КонецЕсли;
				//Если НЕ _Item.certifiedConsignment.batch.packageList = Неопределено Тогда
				//	Для каждого _package Из _Item.certifiedConsignment.batch.packageList.package Цикл
				//		_тест = _package.Свойства().Получить("name");
				//		_тест = _package.Свойства().Получить("uuid");
				//		_тест = _package.Свойства().Получить("guid");
				//		_тест = _package.Свойства().Получить("globalID");
				//	КонецЦикла;
				//КонецЕсли;
			КонецЦикла;
			Пока ВетисMercuryApplications.GetVetDocumentListNext(_enterpriseGuid, _businessEntityGuid, ВетисКонстанты.VetDocumentType_OUTGOING(), ВетисКонстанты.VetDocumentStatus_CONFIRMED(), _Item, _параметры, _Отказ, _Ошибка) Цикл
				Если _Отказ = Истина Тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			ОтчетДополнить("GetVetDocumentList", ?(_Отказ, _Ошибка, "Ок (total:"+_параметры.ListResponse.total+")"));
		Исключение
			ОтчетДополнить("GetVetDocumentList", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
	Иначе
		
		_businessEntityGuid = ВетисDictionaryСлой1с.BusinessEntity(Объект.ХозяйствующийСубъект);
		_enterpriseGuid     = ВетисDictionaryСлой1с.Enterprise(Объект.Предприятие);
		
		_businessEntity = ВетисDictionary.BusinessEntity(ВетисDictionaryСлой1с.BusinessEntity(Объект.ХозяйствующийСубъект));
		_enterprise     = ВетисDictionary.Enterprise(ВетисDictionaryСлой1с.Enterprise(Объект.Предприятие));
		
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОтчетДополнить(пЭтап, пРезультат)
	
	_ОтчетСтрока = Отчет.Добавить();
	_ОтчетСтрока.Этап = пЭтап;
	_ОтчетСтрока.Результат = пРезультат;
	
КонецПроцедуры
