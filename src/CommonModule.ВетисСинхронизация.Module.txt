
Процедура ЗапуститьФоновое(пИмя) Экспорт
	
	ФоновыеЗадания.Выполнить("ВетисСинхронизация."+пИмя);
	
КонецПроцедуры

Процедура ПервыйЗапуск() Экспорт
	
	PackingForm();
	
	IncorporationForm();
	
КонецПроцедуры

Процедура НачальноеЗаполнение(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ СинхронизацияВозможна(пОтказ, пОшибка) Тогда
		Возврат;
	КонецЕсли;
	
	Purpose(пОтказ, пОшибка);
	Если пОтказ = Истина Тогда
		Возврат;
	КонецЕсли;
	
	Product(пОтказ, пОшибка);
	Если пОтказ = Истина Тогда
		Возврат;
	КонецЕсли;
	
	SubProduct(пОтказ, пОшибка);
	Если пОтказ = Истина Тогда
		Возврат;
	КонецЕсли;
	
	//RegionalizationCondition(_Отказ);
	//Если пОтказ = Истина Тогда
	//	Возврат;
	//КонецЕсли;
	
	//VetDocumentList(_Отказ);
	//Если пОтказ = Истина Тогда
	//	Возврат;
	//КонецЕсли;
	
КонецПроцедуры


Процедура СинхронизироватьРегл() Экспорт
	
	Перем _Отказ, _Ошибка;
	
	Если НЕ Ветис.Настройки_РегламентныеЗадания() Тогда
		Возврат;
	КонецЕсли;
	
	Синхронизировать(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		ВетисОбщегоНазначения.ВывестиСообщение(_Ошибка);
	КонецЕсли;
	
КонецПроцедуры

Процедура Синхронизировать(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ СинхронизацияВозможна(пОтказ, пОшибка) Тогда
		Возврат;
	КонецЕсли;
	
	//ВетисОбщегоНазначения.Пауза(30);
	
	_Отказ = Ложь; _Ошибка = "";
	
	НачальноеЗаполнение(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	UnitChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	PurposeChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	ProductChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	SubProductChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	CountryChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	RegionChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	DistrictChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
	_Отказ = Ложь; _Ошибка = "";
	
	LocalityChanges(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		пОтказ = пОтказ ИЛИ _Отказ;
		пОшибка = пОшибка + ?(пОшибка = "", "", Символы.ПС) + _Ошибка;
	КонецЕсли;
	
КонецПроцедуры


Процедура СинхронизироватьBusinessEntity(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ Ветис.Настройки_РегламентныеЗадания() Тогда
		Возврат;
	КонецЕсли;
	
	BusinessEntityChanges(пОтказ, пОшибка);
	
	Если пОтказ = Истина Тогда
		ВетисОбщегоНазначения.ВывестиСообщение(пОшибка);
	КонецЕсли;
	
КонецПроцедуры

Процедура СинхронизироватьStockEntry(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ Ветис.Настройки_РегламентныеЗадания() Тогда
		Возврат;
	КонецЕсли;
	
	StockEntryListChanges(пОтказ, пОшибка);
	
	//Если пОтказ = Истина Тогда
	//	ВетисОбщегоНазначения.ВывестиСообщение(пОшибка);
	//КонецЕсли;
	
КонецПроцедуры

Процедура СинхронизироватьVetDocument(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ Ветис.Настройки_РегламентныеЗадания() Тогда
		Возврат;
	КонецЕсли;
	
	VetDocumentListChanges(пОтказ, пОшибка);
	
	//Если пОтказ = Истина Тогда
	//	ВетисОбщегоНазначения.ВывестиСообщение(пОшибка);
	//КонецЕсли;
	
КонецПроцедуры


Процедура ОтложенныеОперацииРегл() Экспорт
	
	Перем _Отказ, _Ошибка;
	
	Если НЕ Ветис.Настройки_РегламентныеЗадания() Тогда
		Возврат;
	КонецЕсли;
	
	ОтложенныеОперации(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		ВетисОбщегоНазначения.ВывестиСообщение(_Ошибка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтложенныеОперации(пОтказ = Ложь, пОшибка = "", пОтбор = Неопределено, пУИД = Неопределено) Экспорт
	
	Если НЕ СинхронизацияВозможна() Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Таблица.Период КАК Период,
	|	_Таблица.Миллисекунды КАК Миллисекунды,
	|	_Таблица.УникальныйИдентификатор,
	|	_Таблица.Объект,
	|	_Таблица.Операция,
	|	_Таблица.Настройка,
	|	_Таблица.Параметры,
	|	_Таблица.Объект.СтатусТранзакции КАК СтатусТранзакции,
	|	_Таблица.Объект.Статус КАК Статус,
	|	_Таблица.Объект.Проведен КАК Проведен,
	|	_Таблица.Ответственный.Логин КАК Логин
	|ИЗ
	|	РегистрСведений.ВетисОтложенныеОперации КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И НЕ _Таблица.Завершено
	|//1	И _Таблица.Объект В(&Объект)
	|//2	И _Таблица.УникальныйИдентификатор В(&УникальныйИдентификатор)
	|	И ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период,
	|	Миллисекунды");
	
	Если НЕ пОтбор = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//1", "");
		Запрос.УстановитьПараметр("Объект", пОтбор);
	КонецЕсли;
	
	Если НЕ пУИД = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//2", "");
		Запрос.УстановитьПараметр("УникальныйИдентификатор", пУИД);
	КонецЕсли;
	
	Попытка
		Результат = Запрос.Выполнить();
	Исключение
		_СообщениеОбОшибке = Новый Массив;
		_СообщениеОбОшибке.Добавить(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		_СообщениеОбОшибке.Добавить("УИД: "+пУИД);
		_СообщениеОбОшибке.Добавить("Отбор: "+пОтбор);
		ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(_СообщениеОбОшибке);
		//ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке());
		ВызватьИсключение;
	КонецПопытки;
	
	Выборка = Результат.Выбрать();
	
	пОтказ = Ложь;
	пОшибка = "";
	
	_НеПроведен = "Не проведен";
	_НеОбработано = "Не обработано";
	_ОбъектНеПредусмотрен = "Объект не предусмотрен";
	_СтатусНеСоответствует = "Статус не соответствует";
	_ОперацияНеПредусмотрена = "Операция не предусмотрена";
	_СтатусТранзакцииНеСоответствует = "Статус транзакции не соответствует";
	
	Пока Выборка.Следующий() Цикл
		
		_Отказ = Ложь; _Ошибка = ""; _Сообщение = "";
		
		_Параметры = Выборка.Параметры.Получить();
		
		_Параметры = ?(ТипЗнч(_Параметры) = Тип("Структура"), _Параметры, Новый Структура);
		
		_Причина = ?(_Параметры.Свойство("Причина"), _Параметры.Причина, "Отмена");
		
		Если НЕ Выборка.Проведен Тогда
			_Сообщение = _НеПроведен;
		ИначеЕсли ТипЗнч(Выборка.Объект) = Тип("ДокументСсылка.ВетисВетеринарноСопроводительныйДокумент") Тогда
			Если Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.Погасить")
				ИЛИ Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.ПоУмолчанию") Тогда
				//бумажный или электронный
				Если Выборка.Статус = ПредопределенноеЗначение("Перечисление.ВетисVetDocumentStatus.Оформлен")
					ИЛИ Выборка.Статус = ПредопределенноеЗначение("Перечисление.ВетисVetDocumentStatus.ПустаяСсылка") Тогда
					ВетисMercuryApplicationsСлой1с.IncomingOperationVetDocument(Выборка.Объект, Выборка.Настройка, Выборка.Логин, _Отказ, _Ошибка);
				Иначе
					_Сообщение = _СтатусНеСоответствует;
				КонецЕсли;
			ИначеЕсли Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.Аннулировать") Тогда
				Если Выборка.Статус = ПредопределенноеЗначение("Перечисление.ВетисVetDocumentStatus.Оформлен") Тогда
					ВетисMercuryApplicationsСлой1с.WithdrawVetDocumentOperation(Выборка.Объект, _Причина, Выборка.Настройка, Выборка.Логин, _Отказ, _Ошибка);
				Иначе
					_Сообщение = _СтатусНеСоответствует;
				КонецЕсли;
			ИначеЕсли Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.Вернуть") Тогда
				Если Выборка.Статус = ПредопределенноеЗначение("Перечисление.ВетисVetDocumentStatus.Оформлен") Тогда
					ВетисMercuryApplicationsСлой1с.IncomingOperationVetDocument(Выборка.Объект, Выборка.Настройка, Выборка.Логин, _Отказ, _Ошибка);
				Иначе
					_Сообщение = _СтатусНеСоответствует;
				КонецЕсли;
			Иначе
				_Сообщение = _ОперацияНеПредусмотрена;
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(Выборка.Объект) = Тип("ДокументСсылка.ВетисВходящаяПартияПоДокументам") Тогда
			//только гашение, возврат описывается внутри документа
			Если Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.Погасить")
				ИЛИ Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.ПоУмолчанию") Тогда
				Если Выборка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.ПустаяСсылка")
					ИЛИ Выборка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.НеОтправлена") Тогда
					ВетисMercuryApplicationsСлой1с.IncomingOperation(Выборка.Объект, Выборка.Настройка, Выборка.Логин, _Отказ, _Ошибка);
				Иначе
					_Сообщение = _СтатусТранзакцииНеСоответствует;
				КонецЕсли;
			Иначе
				_Сообщение = _ОперацияНеПредусмотрена;
			КонецЕсли;
			
		ИначеЕсли ТипЗнч(Выборка.Объект) = Тип("ДокументСсылка.ВетисТранспортнаяПартия") Тогда
			Если Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.ПоУмолчанию")
				ИЛИ Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.Отправить") Тогда
				Если Выборка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.ПустаяСсылка")
					ИЛИ Выборка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.НеОтправлена") Тогда
					TransportOperation1(Выборка.Объект, Выборка.Настройка, Выборка.Логин, _Отказ, _Ошибка);
					Если _Отказ = Истина И _Ошибка = "Превышено время ожидания" Тогда
						//возможна ситуация когда всд в сервисе созданы, но ответа не дождались
						//как вариант сделать запрос всд по дате и получателю и сопоставлять по продукции и весу
						//если не нашли оставляем
						//....
						//РегистрыСведений.ВетисОтложенныеОперации.Удалить(Выборка.УникальныйИдентификатор, _Ошибка, Истина, Ложь);
						//пока оставим на ручную обработку
						//ПолучитьВСД(Выборка.Объект)
					КонецЕсли;
				Иначе
					_Сообщение = _СтатусТранзакцииНеСоответствует;
				КонецЕсли;
			ИначеЕсли Выборка.Операция = ПредопределенноеЗначение("Перечисление.ВетисОтложенныеОперации.Аннулировать") Тогда
				Если Выборка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.Отправлена") Тогда
					ВетисMercuryApplicationsСлой1с.WithdrawTransportOperation(Выборка.Объект, _Причина, Выборка.Настройка, Выборка.Логин, _Отказ, _Ошибка);
				КонецЕсли;
			Иначе
				_Сообщение = _ОперацияНеПредусмотрена;
			КонецЕсли;
		Иначе
			_Сообщение = _ОбъектНеПредусмотрен;
		КонецЕсли;
		
		Если _Отказ = Истина Тогда
			пОтказ = Истина;
			пОшибка = пОшибка + ?(_Ошибка = "", "", ?(пОшибка="","",Символы.ПС) + _Ошибка);
			РегистрыСведений.ВетисОтложенныеОперации.Удалить(Выборка.УникальныйИдентификатор, _Ошибка, Истина);
		Иначе
			РегистрыСведений.ВетисОтложенныеОперации.Удалить(Выборка.УникальныйИдентификатор, _Сообщение);
		КонецЕсли;
		
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьВСД(пТранспортнаяПартияСсылка)
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Транспортная.Ссылка КАК Траспортная,
	|	_ВСД.Ссылка КАК ВСД,
	|	_ВСДТТН.Номер КАК ВНомер,
	|	_ВСДТТН.Дата КАК ВДата,
	|	_ВСДТТН.Тип КАК ВТип,
	|	_ВСДТТН.ТипТранспорта КАК ВТипТранспорта,
	|	_ТранспортнаяТТН.Номер КАК ТНомер,
	|	_ТранспортнаяТТН.Дата КАК ТДата,
	|	_ТранспортнаяТТН.Тип КАК ТТип,
	|	_ТранспортнаяТТН.ТипТранспорта КАК ТТипТранспорта,
	|	_ВСДТТН.СпособХранения КАК ВСпособХранения,
	|	_ТранспортнаяТТН.СпособХранения КАК ТСпособХранения,
	|	_Транспортная.НомерСтроки КАК НомерСтроки,
	|	_Транспортная.StockEntry КАК StockEntry,
	|	_Транспортная.ProductItemName КАК ProductItemName,
	|	_Транспортная.Количество КАК Количество,
	|	_Транспортная.ВСД КАК ВСД1
	|ПОМЕСТИТЬ ВСоединение
	|ИЗ
	|	Документ.ВетисТранспортнаяПартия.Партии КАК _Транспортная
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВетисВетеринарноСопроводительныйДокумент КАК _ВСД
	|		ПО _Транспортная.Ссылка.Отправитель = _ВСД.Отправитель
	|			И _Транспортная.Ссылка.ОтправительПредприятие = _ВСД.ОтправительПредприятие
	|			И _Транспортная.Ссылка.Получатель = _ВСД.Получатель
	|			И _Транспортная.Ссылка.ПолучательПредприятие = _ВСД.ПолучательПредприятие
	|			И _Транспортная.Ссылка.Дата = _ВСД.Дата
	|			И _Транспортная.StockEntry.SubProduct = _ВСД.SubProduct
	|			И _Транспортная.ProductItemName = _ВСД.ProductItemName
	|			И _Транспортная.Количество = _ВСД.Количество
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВетисВетеринарноСопроводительныйДокумент.ТТН КАК _ВСДТТН
	|		ПО _Транспортная.Ссылка = _ВСДТТН.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВетисТранспортнаяПартия.ТТН КАК _ТранспортнаяТТН
	|		ПО _Транспортная.Ссылка = _ТранспортнаяТТН.Ссылка
	|ГДЕ
	|	ИСТИНА
	|	И _Транспортная.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Траспортная КАК Траспортная,
	|	_Таблица.НомерСтроки КАК НомерСтроки,
	|	_Таблица.StockEntry КАК StockEntry,
	|	_Таблица.ProductItemName КАК ProductItemName,
	|	_Таблица.Количество КАК Количество,
	|	_Таблица.ВСД КАК ВСД
	|ИЗ
	|	ВСоединение КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.ВНомер = _Таблица.ТНомер
	|	И _Таблица.ВДата = _Таблица.ТДата
	|	И _Таблица.ВТип = _Таблица.ТТип
	|	И _Таблица.ВТипТранспорта = _Таблица.ТТипТранспорта
	|	И _Таблица.ВСпособХранения = _Таблица.ТСпособХранения
	|	И ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("Ссылка", пТранспортнаяПартияСсылка);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
	КонецЦикла;
	
КонецФункции


Процедура IncomingOperation1(пОбъектСсылка, issuerId = Неопределено, initiator = Неопределено, пОтказ = Ложь, пОшибка = "")
	
	Если ТипЗнч(пОбъектСсылка) = Тип("ДокументОбъект.ВетисВходящаяПартияПоДокументам") Тогда
		_Объект = пОбъектСсылка;
	Иначе
		_Объект = пОбъектСсылка.ПолучитьОбъект();
	КонецЕсли;
	
	_issuerId = ?(issuerId = Неопределено, _Объект.Получатель, issuerId);
	_initiator = ?(initiator = Неопределено, _Объект.Ответственный, initiator);
	
	ВетисMercuryApplicationsСлой1с.IncomingOperation(_Объект, _issuerId, _initiator, пОтказ, пОшибка);
	
КонецПроцедуры

Функция TransportOperation1(пОбъектСсылка, issuerId = Неопределено, initiator = Неопределено, пОтказ = Ложь, пОшибка = "")
	
	НачатьТранзакцию();
	
	Если ТипЗнч(пОбъектСсылка) = Тип("ДокументОбъект.ВетисТранспортнаяПартия") Тогда
		_ТранспортнаяПартия = пОбъектСсылка;
	Иначе
		_ТранспортнаяПартия = пОбъектСсылка.ПолучитьОбъект();
	КонецЕсли;
	
	Если _ТранспортнаяПартия.ЕстьОшибки И НЕ _ТранспортнаяПартия.РасхожденияСогласованы Тогда
		пОтказ = Истина;
		пОшибка = "Есть ошибки";
		ОтменитьТранзакцию();
		Возврат Неопределено;
	КонецЕсли;
	
	_issuerId = ?(issuerId = Неопределено, _ТранспортнаяПартия.Отправитель, issuerId);
	_initiator = ?(initiator = Неопределено, _ТранспортнаяПартия.Ответственный, initiator);
	
	//при подпитке исходная транзакция модифицируется,
	//а именно партии исходной транзакции становятся партиями подпиточной
	//на место партий исходной транзакции встают партии из погашенных ВСД подпиточной
	//обновление:
	//теперь в исходной транзакции может быть часть партий от отправителя, часть от подпитки
	//соответственно транзакция подпитка должна быть сформирована только на часть строк
	Если _ТранспортнаяПартия.Подпитка Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	_Таблица.НомерСтроки КАК НомерСтроки,
		|	_Таблица.StockEntry КАК StockEntry,
		|	_Таблица.StockEntry.SubProduct КАК SubProduct
		|ИЗ
		|	Документ.ВетисТранспортнаяПартия.Партии КАК _Таблица
		|ГДЕ
		|	ИСТИНА
		|	И _Таблица.Ссылка = &Ссылка
		|	И _Таблица.StockEntry.BusinessEntity = &BusinessEntity
		|	И _Таблица.StockEntry.Enterprise = &Enterprise
		|	И ИСТИНА");
		Запрос.УстановитьПараметр("Ссылка", _ТранспортнаяПартия.Ссылка);
		Запрос.УстановитьПараметр("BusinessEntity", _ТранспортнаяПартия.ОтправительПодпитка);
		Запрос.УстановитьПараметр("Enterprise", _ТранспортнаяПартия.ОтправительПредприятиеПодпитка);
		
		Результат = Запрос.Выполнить();
		
		_НомераСтрок = Результат.Выгрузить().ВыгрузитьКолонку("НомерСтроки");
		
		//в подавляющем большинстве случаев здесь будет пустая _ТранспортнаяПартия.ТранспортнаяПартияПодпитка
		Если ЗначениеЗаполнено(_ТранспортнаяПартия.ТранспортнаяПартияПодпитка) Тогда
			_ТранспортнаяПартияПодпитка = _ТранспортнаяПартия.ТранспортнаяПартияПодпитка.ПолучитьОбъект();
		Иначе
			_ТранспортнаяПартияПодпитка = Документы.ВетисТранспортнаяПартия.СоздатьДокумент();
		КонецЕсли;
		
		Если НЕ(_ТранспортнаяПартияПодпитка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.Отправлена")
			ИЛИ _ТранспортнаяПартияПодпитка.СтатусТранзакции = ПредопределенноеЗначение("Перечисление.ВетисСтатусТранзакции.Аннулирована")) Тогда
			
			_ТранспортнаяПартияПодпитка.УстановитьСсылкуНового(Документы.ВетисТранспортнаяПартия.ПолучитьСсылку(Новый УникальныйИдентификатор));
			_ТранспортнаяПартияПодпитка.Дата = _ТранспортнаяПартия.Дата;
			_ТранспортнаяПартияПодпитка.ДокументОснование = _ТранспортнаяПартия.Ссылка;
			_ТранспортнаяПартияПодпитка.Получатель = _ТранспортнаяПартия.Отправитель;
			_ТранспортнаяПартияПодпитка.Отправитель = _ТранспортнаяПартия.ОтправительПодпитка;
			_ТранспортнаяПартияПодпитка.ПолучательПредприятие = _ТранспортнаяПартия.ОтправительПредприятие;
			_ТранспортнаяПартияПодпитка.ОтправительПредприятие = _ТранспортнаяПартия.ОтправительПредприятиеПодпитка;
			_ТранспортнаяПартияПодпитка.Ответственный = _ТранспортнаяПартия.Ответственный;
			
			_ТранспортнаяПартияПодпитка.Партии.Очистить();
			_ТранспортнаяПартияПодпитка.Упаковка.Очистить();
			_ТранспортнаяПартияПодпитка.Маркировка.Очистить();
			Для каждого _ПартииСтрока Из _ТранспортнаяПартия.Партии Цикл
				Если НЕ _НомераСтрок.Найти(_ПартииСтрока.НомерСтроки) = Неопределено Тогда
					ЗаполнитьЗначенияСвойств(_ТранспортнаяПартияПодпитка.Партии.Добавить(), _ПартииСтрока);
					Для каждого _УпаковкаСтрока Из _ТранспортнаяПартия.Упаковка.НайтиСтроки(Новый Структура("КлючСвязи", _ПартииСтрока.КлючСтроки)) Цикл
						ЗаполнитьЗначенияСвойств(_ТранспортнаяПартияПодпитка.Упаковка.Добавить(), _УпаковкаСтрока);
						Для каждого _МаркировкаСтрока Из _ТранспортнаяПартия.Маркировка.НайтиСтроки(Новый Структура("КлючСвязи", _УпаковкаСтрока.КлючСтроки)) Цикл
							ЗаполнитьЗначенияСвойств(_ТранспортнаяПартияПодпитка.Маркировка.Добавить(), _МаркировкаСтрока);
						КонецЦикла;
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
			
			_ТранспортнаяПартияПодпитка.РезультатыОсмотра.Загрузить(_ТранспортнаяПартия.РезультатыОсмотра.Выгрузить());
			
			//подразумевается что подпитка это просто смена владельца, т.е. товар остается на месте
			//поэтому УсловияПеремещения не заполняем, ТТН надо заполнять, т.к. на практике (нашими ветеринарами)
			//за ХС закрепляется свое предприятие, а в понимании меркурия это перемещение
			_ТранспортнаяПартияПодпитка.ТТН.Загрузить(_ТранспортнаяПартия.ТТН.Выгрузить());
			
			ВетисMercuryApplicationsСлой1с.TransportOperation(_ТранспортнаяПартияПодпитка, _ТранспортнаяПартияПодпитка.Отправитель, _initiator, пОтказ, пОшибка);
			
			//еще никаких действий не было, просто отменяем транзакцию и выходим
			Если пОтказ = Истина Тогда
				ОтменитьТранзакцию();
				Возврат Неопределено;
			КонецЕсли;
			
			//подпиточная записана в ВетисMercuryApplicationsСлой1с.TransportOperation
			//фиксируем результат
			ЗафиксироватьТранзакцию();
			
			//дальше надо погасить входящие всд и внести изменения в текущую Транспортную Партию
			НачатьТранзакцию();
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(_ТранспортнаяПартия.ТранспортнаяПартияПодпитка) Тогда
			_ТранспортнаяПартия.ТранспортнаяПартияПодпитка = _ТранспортнаяПартияПодпитка.Ссылка;
		КонецЕсли;
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	_Таблица.НомерСтроки,
		|	_Таблица.StockEntry КАК SE1,
		|	_Таблица.ВСД,
		|	_Таблица.ВСД.Статус КАК Статус,
		|	_StockEntry.Ссылка КАК SE2
		|ИЗ
		|	Документ.ВетисТранспортнаяПартия.Партии КАК _Таблица
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВетисStockEntry.VetDocumentList КАК _StockEntry
		|		ПО _Таблица.ВСД = _StockEntry.vetDocument
		|ГДЕ
		|	_Таблица.Ссылка = &Ссылка");
		
		Запрос.УстановитьПараметр("Ссылка", _ТранспортнаяПартияПодпитка.Ссылка);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			_ТранспортнаяПартияСтрока = _ТранспортнаяПартия.Партии[Выборка.НомерСтроки-1];
			Если НЕ ЗначениеЗаполнено(_ТранспортнаяПартияСтрока.ВСД) Тогда
				Если Выборка.Статус = ПредопределенноеЗначение("Перечисление.ВетисVetDocumentStatus.Оформлен") Тогда
					_ПодпиткаГашениеОтвет = ВетисMercuryApplicationsСлой1с.IncomingOperationVetDocument(Выборка.ВСД, _ТранспортнаяПартияПодпитка.Получатель, _initiator, пОтказ, пОшибка);
					Если пОтказ = Истина Тогда
						Продолжить;
					КонецЕсли;
					_ТранспортнаяПартияСтрока.StockEntry = _ПодпиткаГашениеОтвет.StockEntry[0];
				Иначе
					_ТранспортнаяПартияСтрока.StockEntry = Выборка.SE2;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		//если из цикла вышли по ошибке, надо вернуть ошибку и записать _ТранспортнаяПартия
		Если _ТранспортнаяПартия.Модифицированность() Тогда
			Попытка
				_ТранспортнаяПартия.Записать();
			Исключение
				//не удалось записать, будут расхождения
				ОтменитьТранзакцию();
				ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке(), "TransportOperation1: Ошибка при записи Транзакции (" + _ТранспортнаяПартия.Ссылка + ")");
				ВызватьИсключение;
			КонецПопытки;
		КонецЕсли;
		
		//фиксируем
		//здесь у нас подпитка и часть или все партии отправлены
		ЗафиксироватьТранзакцию();
		
		//выходим, на одной из партий произошел сбой, разбираться будем вручную
		Если пОтказ = Истина Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		//запускаем основную транспортную партию
		НачатьТранзакцию();
	КонецЕсли;
	
	_Ответ = ВетисMercuryApplicationsСлой1с.TransportOperation(_ТранспортнаяПартия, _issuerId, _initiator, пОтказ, пОшибка);
	
	//здесь отмена транзакции довольно безболезненна, разбираться будем вручную
	Если пОтказ = Истина Тогда
		ОтменитьТранзакцию();
		_Объект = _ТранспортнаяПартия;
		Ветис.ЖурналОпераций_Добавить(_Ответ.ТекстЗапроса, "prepareOutcomingConsignment", "Запрос", _Объект.ОтправительПредприятие, _Объект.Отправитель, _Объект.Ссылка, _Ответ.Длительность);
		Ветис.ЖурналОпераций_Добавить(_Ответ.ТекстЗапросаЗаявки, "prepareOutcomingConsignment", "Заявка", _Объект.ОтправительПредприятие, _Объект.Отправитель, _Объект.Ссылка, _Ответ.Длительность);
		Ветис.ЖурналОпераций_Добавить(_Ответ.ТекстОшибки, "prepareOutcomingConsignment", "Ответ", _Объект.ОтправительПредприятие, _Объект.Отправитель, _Объект.Ссылка, _Ответ.Длительность);
		//возвращаем отправителю
		ПланыОбмена.ВетисКлиенты.ЗарегистрироватьИзменения(_ТранспортнаяПартия.Ссылка);
	Иначе
		ЗафиксироватьТранзакцию();
	КонецЕсли;
	
	Возврат _Ответ;
	
КонецФункции


Процедура VetDocumentListChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ СинхронизацияВозможна(пОтказ, пОшибка) Тогда
		Возврат;
	КонецЕсли;
	
	_Версия20 = Ветис.Версия_2_0();
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_Таблица.BusinessEntity,
	|	_Таблица.BusinessEntity.guid КАК issuerId,
	|	_Таблица.Enterprise,
	|	_Таблица.Enterprise.guid КАК enterpriseGuid,
	|	ЕСТЬNULL(_Границы.Граница, ДАТАВРЕМЯ(1, 1, 1)) КАК Граница,
	|	ЕСТЬNULL(_Границы.Смещение, 0) КАК Смещение
	|ИЗ
	|	РегистрСведений.ВетисBusinessMembers КАК _Таблица
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			_Таблица.BusinessEntity КАК BusinessEntity,
	|			_Таблица.Enterprise КАК Enterprise,
	|			_Таблица.Граница КАК Граница,
	|			_Таблица.Смещение КАК Смещение
	|		ИЗ
	|			РегистрСведений.ВетисГраницыЗапросов КАК _Таблица
	|		ГДЕ
	|			_Таблица.Операция.Наименование = ""getVetDocumentChangesList"") КАК _Границы
	|		ПО _Таблица.Enterprise = _Границы.Enterprise
	|			И _Таблица.BusinessEntity = _Границы.BusinessEntity
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.Использовать
	|	И _Таблица.Свой
	|
	|УПОРЯДОЧИТЬ ПО
	|	Граница");
	
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		
		_count = Ветис.Настройки_КоличествоОбъектовВСписке();
		
		_общийсписок = Новый Массив;
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			пОтказ = Ложь;
			пОтказОперации = Ложь;
			пОшибка = "";
			
			_offset = ?(ЗначениеЗаполнено(Выборка.Смещение), Выборка.Смещение, 0);
			
			_Период = ПолучитьПериод(Выборка.Граница, _offset);
			
			_параметры = Новый Структура;
			_параметры.Вставить("offset", _offset);
			
			_vetDocument = Неопределено;
			
			_индекс = 0;
			
			Если ЗапросИзменений(_Период.Начало) Тогда
				Пока ВетисMercuryApplications.GetVetDocumentChangesListNext(Выборка.enterpriseGuid, _Период.Начало, _Период.Конец, Выборка.issuerId, _vetDocument, _Параметры, пОтказОперации, пОшибка) Цикл
					
					_certifiedConsignment = ?(_Версия20, _VetDocument.certifiedConsignment, _VetDocument);
					
					_ссылка = Документы.ВетисВетеринарноСопроводительныйДокумент.ПолучитьСсылку(Новый УникальныйИдентификатор(_vetDocument.uuid));
					
					_Объект = _ссылка.ПолучитьОбъект();
					
					Если _Объект = Неопределено Тогда
						_Объект = Документы.ВетисВетеринарноСопроводительныйДокумент.СоздатьДокумент();
						_Объект.УстановитьСсылкуНового(_ссылка);
						_Объект.Дата = ТекущаяДатаСеанса();
					КонецЕсли;
					
					ВетисMercuryVetdocumentСлой1с.VetDocumentКонвертировать(_Объект, _vetDocument);
					
					_Объект.ДополнительныеСвойства.Вставить("Загрузка");
					
					Попытка
						_Объект.Записать(РежимЗаписиДокумента.Проведение);
					Исключение
						пОтказ = Истина;
						пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						Прервать;
					КонецПопытки;
					
					_общийсписок.Добавить(_Объект.Ссылка);
					
				КонецЦикла;
			Иначе
				Пока ВетисMercuryApplications.getVetDocumentListNext(Выборка.enterpriseGuid, Выборка.issuerId, _vetDocument, _Параметры, пОтказОперации, пОшибка) Цикл
					
					_certifiedConsignment = ?(_Версия20, _VetDocument.certifiedConsignment, _VetDocument);
					
					_ссылка = Документы.ВетисВетеринарноСопроводительныйДокумент.ПолучитьСсылку(Новый УникальныйИдентификатор(_vetDocument.uuid));
					
					_Объект = _ссылка.ПолучитьОбъект();
					
					Если _Объект = Неопределено Тогда
						_Объект = Документы.ВетисВетеринарноСопроводительныйДокумент.СоздатьДокумент();
						_Объект.УстановитьСсылкуНового(_ссылка);
						_Объект.Дата = ТекущаяДатаСеанса();
					КонецЕсли;
					
					ВетисMercuryVetdocumentСлой1с.VetDocumentКонвертировать(_Объект, _vetDocument);
					
					_Объект.ДополнительныеСвойства.Вставить("Загрузка");
					
					Попытка
						_Объект.Записать(РежимЗаписиДокумента.Проведение);
					Исключение
						пОтказ = Истина;
						пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
						Прервать;
					КонецПопытки;
					
					_общийсписок.Добавить(_Объект.Ссылка);
					
					_индекс = _индекс + 1;
					Если _индекс >= _count Тогда
						Прервать;
					КонецЕсли;
					
				КонецЦикла;
				
			КонецЕсли;
			
			Если пОтказ Тогда
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка);
				Продолжить;
			КонецЕсли;
			
			Ветис.ЖурналОпераций_Добавить(_параметры.ТекстЗапроса, "getVetDocumentChangesList", "Запрос", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
			
			Если пОтказОперации = Истина Тогда
				Ветис.ЖурналОпераций_Добавить(_параметры.ТекстОшибки, "getVetDocumentChangesList", "Ответ", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
				Если НЕ _offset = _параметры.offset Тогда
					Ветис.Настройки_ГраницыЗапросовПоПредприятию("getVetDocumentChangesList", Выборка.Enterprise, Выборка.BusinessEntity, _Период.Конец, _параметры.offset);
				КонецЕсли;
			Иначе
				Ветис.ЖурналОпераций_Добавить(_параметры.ТекстЗапросаЗаявки, "getVetDocumentChangesList", "Заявка", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
				Ветис.ЖурналОпераций_Добавить(_параметры.ТекстОтвета, "getVetDocumentChangesList", "Ответ", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
				Если _индекс >= _count Тогда
					Ветис.Настройки_ГраницыЗапросовПоПредприятию("getVetDocumentChangesList", Выборка.Enterprise, Выборка.BusinessEntity, _Период.Конец, _параметры.offset + _count);
				Иначе
					Ветис.Настройки_ГраницыЗапросовПоПредприятию("getVetDocumentChangesList", Выборка.Enterprise, Выборка.BusinessEntity, _Период.Конец, 0);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		//обновим статус транзакций по полученным всд
		Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	_Таблица.Ссылка
		|ИЗ
		|	Документ.ВетисТранспортнаяПартия.Партии КАК _Таблица
		|ГДЕ
		|	ИСТИНА
		|	И _Таблица.Ссылка.Проведен
		|	И _Таблица.ВСД В(&список)
		|	И ИСТИНА");
		
		Запрос.УстановитьПараметр("Список", _общийсписок);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			_Объект = Выборка.Ссылка.ПолучитьОбъект();
			_Объект.ДополнительныеСвойства.Вставить("Загрузка");
			_Объект.Записать();
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура StockEntryListChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ СинхронизацияВозможна(пОтказ, пОшибка) Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_Таблица.BusinessEntity,
	|	_Таблица.BusinessEntity.guid КАК issuerId,
	|	_Таблица.Enterprise,
	|	_Таблица.Enterprise.guid КАК enterpriseGuid,
	|	ЕСТЬNULL(_Границы.Граница, ДАТАВРЕМЯ(1, 1, 1)) КАК Граница,
	|	ЕСТЬNULL(_Границы.Смещение, 0) КАК Смещение
	|ИЗ
	|	РегистрСведений.ВетисBusinessMembers КАК _Таблица
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			_Таблица.BusinessEntity КАК BusinessEntity,
	|			_Таблица.Enterprise КАК Enterprise,
	|			_Таблица.Граница КАК Граница,
	|			_Таблица.Смещение КАК Смещение
	|		ИЗ
	|			РегистрСведений.ВетисГраницыЗапросов КАК _Таблица
	|		ГДЕ
	|			_Таблица.Операция.Наименование = ""getStockEntryChangesList"") КАК _Границы
	|		ПО _Таблица.Enterprise = _Границы.Enterprise
	|			И _Таблица.BusinessEntity = _Границы.BusinessEntity
	|ГДЕ
	|	ИСТИНА
	|	И _Таблица.Использовать
	|	И _Таблица.Свой
	|
	|УПОРЯДОЧИТЬ ПО
	|	Граница");
	
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		
		_count = Ветис.Настройки_КоличествоОбъектовВСписке();
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			пОтказ = Ложь;
			пОшибка = "";
			
			_offset = ?(ЗначениеЗаполнено(Выборка.Смещение), Выборка.Смещение, 0);
			
			_Период = ПолучитьПериод(Выборка.Граница, _offset);
			
			_параметры = Новый Структура;
			_параметры.Вставить("offset", _offset);
			
			_stockEntry = Неопределено;
			
			_индекс = 0;
			
			_Исключение = Ложь;
			
			Если ЗапросИзменений(_Период.Начало) Тогда
				
				Пока ВетисMercuryApplications.getStockEntryChangesListNext(Выборка.enterpriseGuid, _Период.Начало, _Период.Конец, Выборка.issuerId, _stockEntry, _параметры, пОтказ, пОшибка) Цикл
					
					_se = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисStockEntry, _stockEntry.guid);
					_se.BusinessEntity = Выборка.BusinessEntity;
					_se.Enterprise = Выборка.Enterprise;
					Попытка
						_se.Заполнить(_stockEntry);
						_se.Записать();
					Исключение
						_Исключение = Истина;
						_ТекстОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
						ВетисОбщегоНазначения.ВывестиСообщение(_ТекстОшибки, Выборка.Enterprise);
						Прервать;
					КонецПопытки;
					
				КонецЦикла;
			Иначе
				_параметры.Вставить("searchPattern", ВетисКонстанты.StockEntryBlankFilter_NOT_BLANK());
				Пока ВетисMercuryApplications.getStockEntryListNext(Выборка.enterpriseGuid, Выборка.issuerId, _stockEntry, _параметры, пОтказ, пОшибка) Цикл
					
					_se = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисStockEntry, _stockEntry.guid);
					_se.BusinessEntity = Выборка.BusinessEntity;
					_se.Enterprise = Выборка.Enterprise;
					Попытка
						_se.Заполнить(_stockEntry);
						_se.Записать();
					Исключение
						_Исключение = Истина;
						_ТекстОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
						ВетисОбщегоНазначения.ВывестиСообщение(_ТекстОшибки, Выборка.Enterprise);
						Прервать;
					КонецПопытки;
					
				КонецЦикла;
				
			КонецЕсли;
			
			Ветис.ЖурналОпераций_Добавить(_параметры.ТекстЗапроса, "getStockEntryChangesList", "Запрос", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
			Ветис.ЖурналОпераций_Добавить(_параметры.ТекстЗапросаЗаявки, "getStockEntryChangesList", "Заявка", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
			
			Если _Исключение = Истина Тогда
				Ветис.ЖурналОпераций_Добавить(_ТекстОшибки, "getStockEntryChangesList", "Ответ", Выборка.Enterprise, Выборка.BusinessEntity);
			ИначеЕсли пОтказ = Истина Тогда
				Ветис.ЖурналОпераций_Добавить(_параметры.ТекстОшибки, "getStockEntryChangesList", "Ответ", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
				Если НЕ _offset = _параметры.offset Тогда
					Ветис.Настройки_ГраницыЗапросовПоПредприятию("getStockEntryChangesList", Выборка.Enterprise, Выборка.BusinessEntity, _Период.Конец, _параметры.offset);
				КонецЕсли;
			Иначе
				Ветис.ЖурналОпераций_Добавить(_параметры.ТекстОтвета, "getStockEntryChangesList", "Ответ", Выборка.Enterprise, Выборка.BusinessEntity, , _параметры.Длительность);
				Если _индекс >= _count Тогда
					Ветис.Настройки_ГраницыЗапросовПоПредприятию("getStockEntryChangesList", Выборка.Enterprise, Выборка.BusinessEntity, _Период.Конец, _параметры.offset + _count);
				Иначе
					Ветис.Настройки_ГраницыЗапросовПоПредприятию("getStockEntryChangesList", Выборка.Enterprise, Выборка.BusinessEntity, _Период.Конец, 0);
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры


Процедура PackingForm() Экспорт
	
	Если НЕ Справочники.ВетисPackingForm.Выбрать().Следующий() Тогда
		Возврат;
	КонецЕсли;
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("globalID", Новый ОписаниеТипов("Строка"));
	
	Макет = Справочники.ВетисPackingForm.ПолучитьМакет("СписокФормУпаковок_2_0");
	
	Для НомерСтроки = 1 По Макет.ВысотаТаблицы Цикл
		
		ТаблицаСтрока = _ТаблицаВетис.Добавить();
		
		ТаблицаСтрока.guid = Макет.Область(НомерСтроки, 1).Текст;
		ТаблицаСтрока.name = Макет.Область(НомерСтроки, 2).Текст;
		ТаблицаСтрока.globalID = Макет.Область(НомерСтроки, 3).Текст;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.globalID КАК СТРОКА(2)) КАК globalID
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	guid
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование КАК Наименование,
	|	_Таблица.globalID КАК _globalID,
	|	_Таблица.guid КАК _guid,
	|	_Ветис.name КАК name,
	|	_Ветис.guid КАК guid,
	|	_Ветис.globalID КАК globalID
	|ИЗ
	|	Справочник.ВетисPackingForm КАК _Таблица
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТаблицаВетис КАК _Ветис
	|		ПО (_Таблица.guid = _Ветис.guid)
	//|			И НЕ _Таблица.ПометкаУдаления
	|ГДЕ
	|	ИСТИНА
	|	И НЕ _Таблица.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	_Ветис.name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.PackingForm";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли ПустаяСтрока(Выборка.globalID) Тогда
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка._globalID = СокрЛП(Выборка.globalID);
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисPackingForm, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.globalID     = СокрЛП(Выборка.globalID);
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
		
КонецПроцедуры

Процедура Purpose(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ Справочники.ВетисPurpose.Выбрать().Следующий() Тогда	
		Возврат;
	КонецЕсли;
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("forSubstandard", Новый ОписаниеТипов("Булево"));
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисDictionaryService.GetPurposeListNext(_Выборка, _параметры) Цикл
		ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _Выборка);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.forSubstandard КАК БУЛЕВО) КАК forSubstandard
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	guid
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование КАК Наименование,
	|	_Таблица.forSubstandard КАК НекачественныйГруз,
	|	_Ветис.name КАК name,
	|	_Ветис.guid КАК guid,
	|	_Ветис.forSubstandard КАК forSubstandard
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисPurpose КАК _Таблица
	|		ПО _Ветис.guid = _Таблица.guid
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.Purpose";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.НекачественныйГруз = Выборка.forSubstandard;
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисPurpose, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.forSubstandard = Выборка.forSubstandard;
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetPurposeChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура RegionalizationCondition(пЗаболевание = Неопределено, пОтказ = Ложь, пОшибка = "") Экспорт
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("referenceNumber", Новый ОписаниеТипов("Число"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("text", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("strict", Новый ОписаниеТипов("Булево"));
	
	_ТаблицаЗаболевания = Новый ТаблицаЗначений;
	_ТаблицаЗаболевания.Колонки.Добавить("guid");
	_ТаблицаЗаболевания.Колонки.Добавить("name");
	
	_дубли = Новый Массив;
	
	_Заболевание = ВетисDictionaryСлой1с.AnimalDisease(пЗаболевание);
	
	_Условие = Неопределено; _параметры = Неопределено;
	Пока ВетисRegionalizationService.GetR13nConditionListNext(_Заболевание, _Условие, _параметры, пОтказ, пОшибка) Цикл
		
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Условие.guid);
		
		Если _дубли.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_дубли.Добавить(_УникальныйИдентификатор);
		Иначе
			Продолжить;
		КонецЕсли;
		
		_Строка = _ТаблицаВетис.Добавить();
		_Строка.referenceNumber = _Условие.referenceNumber;
		_Строка.guid   = _Условие.guid;
		_Строка.text   = _Условие.text;
		_Строка.strict = _Условие.strict;
		
		Для каждого _relatedDisease Из _Условие.relatedDisease Цикл
			_ТаблицаЗаболеванияСтрока = _ТаблицаЗаболевания.Добавить();
			_ТаблицаЗаболеванияСтрока.guid = _relatedDisease.guid;
			_ТаблицаЗаболеванияСтрока.name = _relatedDisease.name;
		КонецЦикла;
	КонецЦикла;
	
	Если пОтказ = Истина Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.referenceNumber КАК ЧИСЛО) КАК referenceNumber,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.text КАК СТРОКА(255)) КАК text,
	|	ВЫРАЗИТЬ(_Таблица.strict КАК БУЛЕВО) КАК strict
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	guid
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Ссылка.Наименование КАК Наименование,
	|	_Таблица.Ссылка.referenceNumber КАК НомерУсловия,
	|	_Таблица.Ссылка.text КАК ФормулировкаУсловия,
	|	_Таблица.Ссылка.strict КАК Обязательность,
	//|	_Таблица.Ссылка.relatedDisease КАК Заболевание,
	|	_Ветис.referenceNumber КАК referenceNumber,
	|	_Ветис.guid КАК guid,
	|	_Ветис.text КАК text,
	|	_Ветис.strict КАК strict
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисRegionalizationCondition КАК _Таблица
	|		ПО (_Ветис.guid = _Таблица.guid)
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	text";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_ЗаболеваниеСоответствие = Новый Соответствие;
	
	_контекст = "Синхронизация.RegionalizationCondition";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.НомерУсловия = СокрЛП(Выборка.referenceNumber)
			ИЛИ НЕ Выборка.ФормулировкаУсловия = Выборка.text
			ИЛИ НЕ Выборка.Обязательность = Выборка.strict;
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисRegionalizationCondition, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.text);
			_Элемент.referenceNumber = Выборка.referenceNumber;
			_Элемент.text = СокрЛП(Выборка.text);
			_Элемент.strict = Выборка.strict;
			
			//_ТаблицаЗаболеванияСтроки = _ТаблицаЗаболевания.НайтиСтроки(Новый Структура("Condition_уид", _Элемент.уид));
			//Для каждого _ЗаболеваниеСтрока Из _ТаблицаЗаболеванияСтроки Цикл
			//	_Заболевание_уид = Новый УникальныйИдентификатор(_ЗаболеваниеСтрока.guid);
			//	_Заболевание = _ЗаболеваниеСоответствие.Получить(_Заболевание_уид);
			//	Если _Заболевание = Неопределено Тогда
			//		_Заболевание = Справочники.ВетисAnimalDisease.НайтиПоРеквизиту("уид", _Заболевание_уид);
			//		Если НЕ ЗначениеЗаполнено(_Заболевание) Тогда
			//			_Заболевание = Справочники.ВетисAnimalDisease.СоздатьЭлемент();
			//			_Заболевание.guid = _ЗаболеваниеСтрока.guid;
			//			//_Заболевание.уид = _Заболевание_уид;
			//			_Заболевание.Наименование = _ЗаболеваниеСтрока.name;
			//			_Заболевание.Записать();
			//			_Заболевание = _Заболевание.Ссылка;
			//		КонецЕсли;
			//		_ЗаболеваниеСоответствие.Вставить(_Заболевание_уид, _Заболевание);
			//	КонецЕсли;
			//	_Элемент.Заболевания.Добавить().Заболевание = _Заболевание;
			//	_Элемент.relatedDisease = _Заболевание;
			//КонецЦикла;
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура IncorporationForm() Экспорт
	
	Возврат;
	
	Если НЕ Справочники.ВетисIncorporationForm.Выбрать().Следующий() Тогда
		Возврат;
	КонецЕсли;
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("uuid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("code", Новый ОписаниеТипов("Строка"));
	
	_Макет = Справочники.ВетисIncorporationForm.ПолучитьМакет("ОК_028_2012");
	
	Для _НомерСтроки = 1 По _Макет.ВысотаТаблицы Цикл
		
		_ТаблицаСтрока = _ТаблицаВетис.Добавить();
		
		_ТаблицаСтрока.uuid = _Макет.Область(_НомерСтроки, 1).Текст;
		_ТаблицаСтрока.name = _Макет.Область(_НомерСтроки, 3).Текст;
		_ТаблицаСтрока.code = _Макет.Область(_НомерСтроки, 2).Текст;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.uuid КАК СТРОКА(36)) КАК uuid,
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.code КАК СТРОКА(5)) КАК code
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	code
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование,
	|	_Таблица.Код,
	|	_Ветис.uuid КАК uuid,
	|	_Ветис.name КАК name,
	|	_Ветис.code КАК code
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисIncorporationForm КАК _Таблица
	|		ПО _Ветис.code = _Таблица.Код
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	_Ветис.name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.IncorporationForm";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.code = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.Код = СокрЛП(Выборка.code);
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисIncorporationForm, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.uuid         = Выборка.uuid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.Код          = СокрЛП(Выборка.code);
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
		
КонецПроцедуры

Процедура Product(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ Справочники.ВетисProduct.Выбрать().Следующий() Тогда
		Возврат;
	КонецЕсли;
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("productType", Новый ОписаниеТипов("СправочникСсылка.ВетисProductType"));
	
	Выборка = Справочники.ВетисProductType.Выбрать();
	Пока Выборка.Следующий() Цикл
		_productType = ВетисDictionaryСлой1с.ProductType(Выборка.Ссылка);
		_product = Неопределено; _параметры = Неопределено;
		Пока ВетисProductService.GetProductByTypeListNext(_productType, _product, _параметры) Цикл
			_Строка = _ТаблицаВетис.Добавить();
			_Строка.name = _product.name;
			_Строка.guid = _product.guid;
			_Строка.productType = Выборка.Ссылка;
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.productType КАК Справочник.ВетисProductType) КАК productType
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	guid
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование КАК Наименование,
	|	_Таблица.productType КАК ТипПродукции,
	|	_Ветис.name КАК name,
	|	_Ветис.guid КАК guid,
	|	_Ветис.productType КАК productType
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисProduct КАК _Таблица
	|		ПО (_Ветис.guid = _Таблица.guid)
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.Product";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.ТипПродукции = Выборка.productType;
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисProduct, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.productType = Выборка.productType;
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetProductChangesList", _КонецПериода);
	КонецЕсли;
		
КонецПроцедуры

Процедура SubProduct(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ Справочники.ВетисSubProduct.Выбрать().Следующий() Тогда
		Возврат;
	КонецЕсли;
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("productType", Новый ОписаниеТипов("СправочникСсылка.ВетисProductType"));
	_ТаблицаВетис.Колонки.Добавить("product", Новый ОписаниеТипов("СправочникСсылка.ВетисProduct"));
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	_Таблица.Ссылка КАК product,
	|	_Таблица.guid,
	|	_Таблица.productType
	|ИЗ
	|	Справочник.ВетисProduct КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|	И НЕ _Таблица.ПометкаУдаления
	|	И ИСТИНА");
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		_product = ВетисDictionary.Product(Выборка.guid);
		_subProduct = Неопределено; _параметры = Неопределено;
		Пока ВетисProductService.GetSubProductByProductListNext(Выборка.guid, _subProduct, _параметры) Цикл
			_Строка = _ТаблицаВетис.Добавить();
			_Строка.name = _subProduct.name;
			_Строка.guid = _subProduct.guid;
			_Строка.productType = Выборка.productType;
			_Строка.product = Выборка.product;
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.productType КАК Справочник.ВетисProductType) КАК productType,
	|	ВЫРАЗИТЬ(_Таблица.product КАК Справочник.ВетисProduct) КАК product
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	guid
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование КАК Наименование,
	|	_Таблица.productType КАК ТипПродукции,
	|	_Таблица.product КАК Продукция,
	|	_Ветис.name КАК name,
	|	_Ветис.guid КАК guid,
	|	_Ветис.productType КАК productType,
	|	_Ветис.product КАК product
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисSubProduct КАК _Таблица
	|		ПО _Ветис.guid = _Таблица.guid
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.SubProduct";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.ТипПродукции = Выборка.productType
			ИЛИ НЕ Выборка.Продукция = Выборка.product;
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисSubProduct, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.productType  = Выборка.productType;
			_Элемент.product      = Выборка.product;
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetSubProductChangesList", _КонецПериода);
	КонецЕсли;
		
КонецПроцедуры


Процедура UnitChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetUnitChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.Unit";
	
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисDictionaryService.GetUnitChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисUnit, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetUnitChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура PurposeChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetPurposeChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.Purpose";
	
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисDictionaryService.GetPurposeChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисPurpose, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetPurposeChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры


Процедура BusinessEntityChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ СинхронизацияВозможна(пОтказ, пОшибка) Тогда
		Возврат;
	КонецЕсли;
	
	_offset = Неопределено;
	
	_НачалоПериода = Ветис.Настройки_ГраницыЗапросов("GetBusinessEntityChangesList", , _offset);
	
	_offset = ?(ЗначениеЗаполнено(_offset), _offset, 0);
	
	_Период = ПолучитьПериод(_НачалоПериода, _offset);
	
	_count = Ветис.Настройки_КоличествоОбъектовВСписке();
	
	_контекст = "Синхронизация.BusinessEntity";
	
	_параметры = Новый Структура;
	_параметры.Вставить("offset", _offset);
	
	_Выборка = Неопределено;
	_актуальные = Новый Массив;
	_индекс = 0;
	
	Если ЗапросИзменений(_Период.Начало) Тогда
		Пока ВетисEnterpriseService.GetBusinessEntityChangesListNext(_Период.Начало, _Период.Конец, _Выборка, _параметры, пОтказ, пОшибка) Цикл
			_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
			Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
				_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисBusinessEntity, _Выборка.guid);
				_Объект.Заполнить(_Выборка);
				Если ЗаписьАктуальна(_Выборка) Тогда
					_актуальные.Добавить(_УникальныйИдентификатор);
				КонецЕсли;
				Попытка
					_Объект.Записать();
				Исключение
					пОтказ = Истина;
					пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
					ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
					Прервать;
				КонецПопытки;
			КонецЕсли;
		КонецЦикла;
	Иначе
		Пока ВетисEnterpriseService.GetBusinessEntityListNext(_Выборка, _параметры, пОтказ, пОшибка) Цикл
			
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисBusinessEntity, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Попытка
				_Объект.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
			_BusinessMembers = РегистрыСведений.ВетисBusinessMembers.СоздатьНаборЗаписей();
			_BusinessMembers.Отбор.BusinessEntity.Установить(_Объект.Ссылка);
			
			_Enterprise = Неопределено; _параметры1 = Неопределено;
			Пока ВетисEnterpriseService.GetActivityLocationListNext(_Выборка.guid, _Enterprise, _параметры1, пОтказ, пОшибка) Цикл
				_Предприятие = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисEnterprise, _Enterprise.guid);
				_Предприятие.Заполнить(_Enterprise);
				Попытка
					_Предприятие.Записать();
				Исключение
					пОтказ = Истина;
					пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
					ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
					Прервать;
				КонецПопытки;
				_Запись = _BusinessMembers.Добавить();
				_Запись.BusinessEntity = _Объект.Ссылка;
				_Запись.Enterprise = _Предприятие.Ссылка;
				_Запись.Использовать = Истина;
				_Запись.ВСервисе = Истина;
			КонецЦикла;
			
			Если пОтказ = Истина Тогда
				Прервать;
			КонецЕсли;
			
			Попытка
				_BusinessMembers.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
			_индекс = _индекс + 1;
			Если _индекс >= _count Тогда
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
	Если пОтказ = Истина Тогда
		ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, "BusinessEntityChanges");
		Если НЕ _offset = _параметры.offset Тогда
			Ветис.Настройки_ГраницыЗапросов("GetBusinessEntityChangesList", _Период.Конец, _параметры.offset);
		КонецЕсли;
	ИначеЕсли _индекс >= _count Тогда
		Ветис.Настройки_ГраницыЗапросов("GetBusinessEntityChangesList", _Период.Конец, _параметры.offset + _count);
	Иначе
		Ветис.Настройки_ГраницыЗапросов("GetBusinessEntityChangesList", _Период.Конец, 0);
	КонецЕсли;
	
КонецПроцедуры

Процедура EnterpriseChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	Если НЕ СинхронизацияВозможна(пОтказ, пОшибка) Тогда
		Возврат;
	КонецЕсли;
	
	_offset = Неопределено;
	
	_НачалоПериода = Ветис.Настройки_ГраницыЗапросов("GetRussianEnterpriseChangesList", , _offset);
	
	_offset = ?(ЗначениеЗаполнено(_offset), _offset, 0);
	
	_Период = ПолучитьПериод(_НачалоПериода, _offset);
	
	_контекст = "Синхронизация.Enterprise";
	
	_параметры = Новый Структура;
	_параметры.Вставить("offset", _offset);
	
	_Выборка = Неопределено;
	_актуальные = Новый Массив;
	_индекс = 0;
	
	Если ЗапросИзменений(_Период.Начало) Тогда
		Пока ВетисEnterpriseService.GetRussianEnterpriseChangesListNext(_Период.Начало, _Период.Конец, _Выборка, _параметры, пОтказ, пОшибка) Цикл
			_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
			Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
				_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисEnterprise, _Выборка.guid);
				_Объект.Заполнить(_Выборка);
				Если ЗаписьАктуальна(_Выборка) Тогда
					_актуальные.Добавить(_УникальныйИдентификатор);
				КонецЕсли;
				Попытка
					_Объект.Записать();
				Исключение
					пОтказ = Истина;
					пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
					ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
					Прервать;
				КонецПопытки;
			КонецЕсли;
		КонецЦикла;
	Иначе
		Пока ВетисEnterpriseService.GetRussianEnterpriseListNext(_Выборка, _параметры, пОтказ, пОшибка) Цикл
			
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисEnterprise, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
			_индекс = _индекс + 1;
			Если _индекс >= _параметры.ListOptions.count Тогда
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
	Если пОтказ = Истина Тогда
		ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, "EnterpriseChanges");
		Если НЕ _offset = _параметры.offset Тогда
			Ветис.Настройки_ГраницыЗапросов("GetRussianEnterpriseChangesList", , _параметры.offset);
		КонецЕсли;
	ИначеЕсли _индекс >= _параметры.ListOptions.count Тогда
		Ветис.Настройки_ГраницыЗапросов("GetRussianEnterpriseChangesList", _Период.Конец, _параметры.offset + _параметры.ListOptions.count);
	Иначе
		Ветис.Настройки_ГраницыЗапросов("GetRussianEnterpriseChangesList", _Период.Конец, 0);
	КонецЕсли;
	
КонецПроцедуры


Процедура CountryChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetCountryChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.Country";
	
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисIkarService.GetCountryChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисCountry, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetCountryChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура RegionChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetRegionChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.Region";
	
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисIkarService.GetRegionChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисRegion, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetRegionChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура DistrictChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetDistrictChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.District";
	
	//добавляем поиск по актуальным в текущем проходе
	//т.к. из операции приходят не в порядке изменения версий
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисIkarService.GetDistrictChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисDistrict, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetDistrictChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура LocalityChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	//этой операции нет в сервисе, поэтому делаем полную загрузку
	
	Возврат;
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("view", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("regionGuid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("districtGuid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("countryGuid", Новый ОписаниеТипов("Строка"));
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_Таблица.guid
	|ИЗ
	|	Справочник.ВетисRegion КАК _Таблица
	|ГДЕ
	|	НЕ _Таблица.ПометкаУдаления");
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		_locality = Неопределено; _параметры = Неопределено;
		Пока ВетисIkarService.GetLocalityListByRegionNext(Выборка.guid, _locality, _параметры) Цикл
			_locality.regionGuid = Выборка.guid;
			ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_Таблица.guid,
	|	_Таблица.Region.guid КАК regionGuid
	|ИЗ
	|	Справочник.ВетисDistrict КАК _Таблица
	|ГДЕ
	|	НЕ _Таблица.ПометкаУдаления");
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		_locality = Неопределено; _параметры = Неопределено;
		Пока ВетисIkarService.GetLocalityListByDistrictNext(Выборка.guid, _locality, _параметры) Цикл
			_locality.regionGuid = Выборка.regionGuid;
			_locality.districtGuid = Выборка.guid;
			ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.view КАК СТРОКА(255)) КАК view,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.countryGuid КАК СТРОКА(36)) КАК countryGuid,
	|	ВЫРАЗИТЬ(_Таблица.regionGuid КАК СТРОКА(36)) КАК regionGuid,
	|	ВЫРАЗИТЬ(_Таблица.districtGuid КАК СТРОКА(36)) КАК districtGuid
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	guid,
	|	countryGuid,
	|	regionGuid,
	|	districtGuid
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование,
	|	_Таблица.view КАК Представление,
	|	_Таблица.Country КАК Страна,
	|	_Таблица.Region КАК Регион,
	|	_Таблица.District КАК Район,
	|	_Ветис.name КАК name,
	|	_Ветис.view КАК view,
	|	_Ветис.guid КАК guid,
	|	_Страна.Ссылка КАК country,
	|	_Регион.Ссылка КАК region,
	|	_Район.Ссылка КАК district
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВетисCountry КАК _Страна
	|		ПО _Ветис.countryGuid = _Страна.guid
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВетисRegion КАК _Регион
	|		ПО _Ветис.regionGuid = _Регион.guid
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВетисDistrict КАК _Район
	|		ПО _Ветис.districtGuid = _Район.guid
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисLocality КАК _Таблица
	|		ПО _Ветис.guid = _Таблица.guid
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	name";
	
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.Locality";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.Представление = СокрЛП(Выборка.view)
			ИЛИ НЕ Выборка.Страна = Выборка.country
			ИЛИ НЕ Выборка.Регион = Выборка.region
			ИЛИ НЕ Выборка.Район = Выборка.district;
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисLocality, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.view         = СокрЛП(Выборка.view);
			_Элемент.country      = Выборка.country;
			_Элемент.region       = Выборка.region;
			_Элемент.district     = Выборка.district;
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура Locality(пСтрана, пРегион = Неопределено, пРайон = Неопределено, пОтказ = Ложь, пОшибка = "") Экспорт
	
	_Версия20 = Ветис.Версия_2_0();
	
	_countryGuid = ВетисDictionaryСлой1с.Country(пСтрана);
	
	_ТаблицаВетис = Новый ТаблицаЗначений;
	_ТаблицаВетис.Колонки.Добавить("name", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("guid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("view", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("regionGuid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("districtGuid", Новый ОписаниеТипов("Строка"));
	_ТаблицаВетис.Колонки.Добавить("countryGuid", Новый ОписаниеТипов("Строка"));
	
	Если пРегион = Неопределено Тогда
		_region = Неопределено; _параметрыR = Неопределено;
		Пока ВетисIkarService.GetRegionListByCountryNext(_countryGuid, _region, _параметрыR) Цикл
			_locality = Неопределено; _параметры = Неопределено;
			Пока ВетисIkarService.GetLocalityListByRegionNext(_region.Guid, _locality, _параметры) Цикл
				_locality.regionGuid = _region.Guid;
				ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
			КонецЦикла;
			Если пРайон = Неопределено Тогда
				_district = Неопределено; _параметрыD = Неопределено;
				Пока ВетисIkarService.GetDistrictListByRegionNext(_region.guid, _district, _параметрыD) Цикл
					_locality = Неопределено; _параметры = Неопределено;
					Пока ВетисIkarService.GetLocalityListByDistrictNext(_district.Guid, _locality, _параметры) Цикл
						ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
					КонецЦикла;
				КонецЦикла;
			Иначе
				_districtGuid = пРайон.guid;
				_locality = Неопределено; _параметры = Неопределено;
				Пока ВетисIkarService.GetLocalityListByDistrictNext(_districtGuid, _locality, _параметры) Цикл
					ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	Иначе
		
		_regionGuid = пРегион.guid;
		
		Если пРайон = Неопределено Тогда
			
			_locality = Неопределено; _параметры = Неопределено;
			Пока ВетисIkarService.GetLocalityListByRegionNext(_regionGuid, _locality, _параметры) Цикл
				_locality.regionGuid = _regionGuid;
				ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
			КонецЦикла;
			
			_district = Неопределено; _параметрыD = Неопределено;
			Пока ВетисIkarService.GetDistrictListByRegionNext(_regionGuid, _district, _параметрыD) Цикл
				_locality = Неопределено; _параметры = Неопределено;
				Пока ВетисIkarService.GetLocalityListByDistrictNext(_district.Guid, _locality, _параметры) Цикл
					_locality.regionGuid = _regionGuid;
					_locality.districtGuid = _district.Guid;
					ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
				КонецЦикла;
			КонецЦикла;
		Иначе
			_districtGuid = пРайон.guid;
			_locality = Неопределено; _параметры = Неопределено;
			Пока ВетисIkarService.GetLocalityListByDistrictNext(_districtGuid, _locality, _параметры) Цикл
				_locality.regionGuid = _regionGuid;
				_locality.districtGuid = _districtGuid;
				ЗаполнитьЗначенияСвойств(_ТаблицаВетис.Добавить(), _locality);
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(_Таблица.name КАК СТРОКА(150)) КАК name,
	|	ВЫРАЗИТЬ(_Таблица.view КАК СТРОКА(255)) КАК view,
	|	ВЫРАЗИТЬ(_Таблица.guid КАК СТРОКА(36)) КАК guid,
	|	ВЫРАЗИТЬ(_Таблица.districtGuid КАК СТРОКА(36)) КАК districtGuid,
	|	ВЫРАЗИТЬ(_Таблица.regionGuid КАК СТРОКА(36)) КАК regionGuid,
	|	ВЫРАЗИТЬ(_Таблица.countryGuid КАК СТРОКА(36)) КАК countryGuid
	|ПОМЕСТИТЬ ВТаблицаВетис
	|ИЗ
	|	&ТаблицаВетис КАК _Таблица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_Таблица.Ссылка,
	|	_Таблица.ПометкаУдаления,
	|	_Таблица.Наименование,
	|	_Таблица.Представление,
	|	_Таблица.Region КАК Регион,
	|	_Таблица.District КАК Район,
	|	_Ветис.name КАК name,
	|	_Ветис.view КАК view,
	|	_Ветис.guid КАК guid,
	|	_Район.Ссылка КАК district,
	|	_Регион.Ссылка КАК region
	|ИЗ
	|	ВТаблицаВетис КАК _Ветис
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВетисDistrict КАК _Район
	|		ПО _Ветис.districtGuid = _Район.guid
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВетисRegion КАК _Регион
	|		ПО _Ветис.regionGuid = _Регион.guid
	|		ПОЛНОЕ СОЕДИНЕНИЕ Справочник.ВетисLocality КАК _Таблица
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			&Страна КАК Страна,
	|			&Регион КАК Регион,
	|			&Район КАК Район) КАК _Отбор
	|		ПО _Таблица.Country = _Отбор.Страна
	|//о1		И _Таблица.Region = _Отбор.Регион
	|//о2		И _Таблица.District = _Отбор.Район
	|		ПО _Ветис.guid = _Таблица.guid
	|ГДЕ
	|	ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	name";
	
	Запрос.УстановитьПараметр("Страна", пСтрана);
	Запрос.УстановитьПараметр("Регион", пРегион);
	Запрос.УстановитьПараметр("Район", пРайон);
	Запрос.УстановитьПараметр("ТаблицаВетис", _ТаблицаВетис);
	
	Если НЕ пРегион = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//о1", "");
	КонецЕсли;
	
	Если НЕ пРайон = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//о2", "");
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_контекст = "Синхронизация.Locality";
	
	Пока Выборка.Следующий() Цикл
		
		_Новый = Ложь;
		
		_ЕстьИзменения = Ложь;
		
		Если Выборка.guid = NULL Тогда
			Попытка
				Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			Исключение
				ВетисОбщегоНазначения.ВывестиСообщениеОбОшибке(ИнформацияОбОшибке(), _контекст);
			КонецПопытки;
			Продолжить;
			
		ИначеЕсли Выборка.Ссылка = NULL Тогда
			_Новый = Истина;
			
		Иначе
			_ЕстьИзменения = Ложь
			ИЛИ Выборка.ПометкаУдаления
			ИЛИ НЕ Выборка.Наименование = СокрЛП(Выборка.name)
			ИЛИ НЕ Выборка.Представление = СокрЛП(Выборка.view)
			ИЛИ НЕ Выборка.Регион = СокрЛП(Выборка.region)
			ИЛИ НЕ Выборка.Район = СокрЛП(Выборка.district);
			
		КонецЕсли;
		
		Если _ЕстьИзменения ИЛИ _Новый Тогда
			
			Если _Новый Тогда
				_Элемент = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисLocality, Выборка.guid);
			Иначе
				_Элемент = Выборка.Ссылка.ПолучитьОбъект();
			КонецЕсли;
			
			_Элемент.ПометкаУдаления = Ложь;
			_Элемент.guid         = Выборка.guid;
			_Элемент.Наименование = СокрЛП(Выборка.name);
			_Элемент.view         = СокрЛП(Выборка.view);
			_Элемент.Country      = пСтрана;
			_Элемент.Region       = Выборка.region;
			_Элемент.District     = Выборка.district;
			
			Попытка
				_Элемент.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ProductChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetProductChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.Product";
	
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисProductService.GetProductChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисProduct, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetProductChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура SubProductChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
	_НачалоПериода = НачалоПериодаОперации("GetSubProductChangesList");
	
	_КонецПериода = ТекущаяДатаСеанса();
	
	_контекст = "Синхронизация.SubProduct";
	
	_актуальные = Новый Массив;
	
	_Выборка = Неопределено; _параметры = Неопределено;
	Пока ВетисProductService.GetSubProductChangesListNext(_НачалоПериода, , _Выборка, _параметры, пОтказ, пОшибка) Цикл
		_УникальныйИдентификатор = Новый УникальныйИдентификатор(_Выборка.guid);
		Если ЗаписьАктуальна(_Выборка) ИЛИ _актуальные.Найти(_УникальныйИдентификатор) = Неопределено Тогда
			_Объект = ВетисОбщегоНазначения.ПолучитьОбъект(Справочники.ВетисSubProduct, _Выборка.guid);
			_Объект.Заполнить(_Выборка);
			Если ЗаписьАктуальна(_Выборка) Тогда
				_актуальные.Добавить(_УникальныйИдентификатор);
			КонецЕсли;
			Попытка
				_Объект.Записать();
			Исключение
				пОтказ = Истина;
				пОшибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ВетисОбщегоНазначения.ВывестиСообщение(пОшибка, _контекст);
				Прервать;
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ пОтказ = Истина Тогда
		Ветис.Настройки_ГраницыЗапросов("GetSubProductChangesList", _КонецПериода);
	КонецЕсли;
	
КонецПроцедуры

Процедура ProductItemChanges(пОтказ = Ложь, пОшибка = "") Экспорт
	
КонецПроцедуры


Функция ЗаписьАктуальна(item)
//100	CREATED - Запись создана.
//101	CREATED_WHEN_QUENCH_VETCERTIFICATE - Запись создана путем гашения ВС (импорт).
//102	CREATED_WHEN_QUENCH_VETDOCUMENT - Запись создана путем гашения ВСД.
//103	CREATED_BY_OPERATION - Запись создана в результате производственной операции.
//110	CREATED_WHEN_MERGE - Запись создана в результате объединения двух или более других.
//120	CREATED_WHEN_SPLIT - Запись создана в результате разделения другой.
//200	UPDATED - В запись были внесены изменения.
//201	WITHDRAWN - Запись журнала аннулирована.
//202	UPDATED_WHEN_WRITINGOFF - Запись продукции изменена путём списания. Необязательно, чтобы продукция была списана полностью, может быть списана и часть объёма.
//230	UPDATED_WHEN_ATTACH - Запись была обновлена в результате присоединения другой.
//231	UPDATED_WHEN_ATTACH_AUTOMATIC - Запись была обновлена в результате присоединения другой.
//240	UPDATED_WHEN_FORK - Запись была обновлена в результате отделения от неё другой.
//250	RESTORED_AFTER_DELETE - Запись была восстановлена после удаления.
//300	MOVED - Запись была перемещена в другую группу (для иерархических справочников).
//400	DELETED - Запись была удалена.
//410	DELETED_WHEN_MERGE - Запись была удалена в результате объединения.
//420	DELETED_WHEN_SPLIT - Запись была удалена в результате разделения.
//430	DELETED_WHEN_ATTACH - Запись была удалена в результате присоединения.
	Возврат (item.status >= 100 И item.status < 200
		ИЛИ item.status = 200
		ИЛИ item.status = 202
		ИЛИ item.status = 230
		ИЛИ item.status = 231
		ИЛИ item.status = 240
		ИЛИ item.status = 250
		ИЛИ item.status = 300)
		И item.last
		И item.active;
		
КонецФункции

Функция НачалоПериодаОперации(пИмяОперации, пСмещение = Неопределено)
	
	_НачалоПериода = Ветис.Настройки_ГраницыЗапросов(пИмяОперации, , пСмещение);
	_НачалоПериода = ?(ЗначениеЗаполнено(_НачалоПериода), _НачалоПериода - Перекрытие(), НачалоПериодаГраниц());
	_НачалоПериода = МестноеВремя(УниверсальноеВремя(_НачалоПериода), "GMT+3");//приводим к мск
	
	пСмещение = ?(ЗначениеЗаполнено(пСмещение), пСмещение, 0);
	
	Возврат _НачалоПериода;
	
КонецФункции

Функция НачалоПериодаГраниц()
	
	Возврат Дата(2000,1,1);
	
КонецФункции

Функция ПолучитьПериод(пНачалоПериода, offset)
	
	Если offset > 0 И ЗначениеЗаполнено(пНачалоПериода) Тогда
		_КонецПериода = пНачалоПериода;
		_НачалоПериода = НачалоПериодаГраниц();
	Иначе
		_НачалоПериода = ?(ЗначениеЗаполнено(пНачалоПериода), пНачалоПериода - Перекрытие(), НачалоПериодаГраниц());
		_НачалоПериода = МестноеВремя(УниверсальноеВремя(_НачалоПериода), "GMT+3");//приводим к мск
		_КонецПериода = ТекущаяДатаСеанса();
	КонецЕсли;
	
	Возврат Новый Структура("Начало, Конец", _НачалоПериода, _КонецПериода);
	
КонецФункции

Функция Перекрытие()
	
	Возврат 15*60;
	//Возврат 1*60*60;
	
КонецФункции

Функция ЗапросИзменений(пНачалоПериода)
	
	//условно делим, можно уменьшить период
	Возврат ТекущаяДатаСеанса() - пНачалоПериода < 30*24*60*60;
	
КонецФункции


Функция СинхронизацияВозможна(пОтказ = Ложь, пОшибка = "")
	
	//если нет настроек, синхронизация невозможна
	Если НЕ ЗначениеЗаполнено(ВетисПовтИсп.ТекущийПользователь_Настройка()) Тогда
		пОтказ = Истина;
		пОшибка = "Не найдена настройка подключения";
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции
