
&НаКлиенте
Процедура КомандаОбновитьХСПредприятие(Команда)
	
	Перем _Отказ, _Ошибка;
	
	ОбновитьСвязиХСПредприятие(, _Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		Сообщить(_Ошибка);
		Возврат;
	КонецЕсли;
	
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ОбновитьСвязиХСПредприятие(пХС = Неопределено, пОтказ = Ложь, пОшибка = "") Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	_Таблица.BusinessEntity КАК ХозяйствующийСубъект,
	|	_Таблица.Enterprise КАК Предприятие,
	|	_Таблица.ВСервисе,
	|	_Таблица.Enterprise.guid КАК EnterpriseGuid,
	|	_Таблица.BusinessEntity.guid КАК BusinessEntityGuid
	|ИЗ
	|	РегистрСведений.ВетисBusinessMembers КАК _Таблица
	|ГДЕ
	|	ИСТИНА
	|//1	И _Таблица.BusinessEntity = &ХС
	|	И ИСТИНА
	|ИТОГИ
	|	МАКСИМУМ(BusinessEntityGuid)
	|ПО
	|	ХозяйствующийСубъект";
	
	_нз = РегистрыСведений.ВетисBusinessMembers.СоздатьНаборЗаписей();
	_нз.ОбменДанными.Загрузка = Истина;
	Если НЕ пХС = Неопределено Тогда
		_нз.Отбор.ХозяйствующийСубъект.Установить(пХС);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//1", "");
		Запрос.УстановитьПараметр("ХС", пХС);
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	ВыборкаХС = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаХС.Следующий() Цикл
		
		_список = Новый Массив;
		_Enterprise = Неопределено;
		_параметры = Неопределено;
		Пока ВетисEnterpriseService.GetActivityLocationListNext(ВыборкаХС.BusinessEntityGuid, _Enterprise, _параметры, пОтказ, пОшибка) Цикл
			_список.Добавить(_Enterprise.guid);
		КонецЦикла;
		
		Если пОтказ = Истина Тогда
			Возврат;
		КонецЕсли;
		
		Выборка = ВыборкаХС.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			Если Выборка.EnterpriseGuid = NULL ИЛИ Выборка.BusinessEntityGuid = NULL ИЛИ _список.Найти(Выборка.EnterpriseGuid) = Неопределено Тогда
				_ВСервисе = Ложь;
			Иначе
				_ВСервисе = Истина;
			КонецЕсли;
			
			_мз = _нз.Добавить();
			_мз.BusinessEntity = Выборка.ХозяйствующийСубъект;
			_мз.Enterprise = Выборка.Предприятие;
			_мз.ВСервисе = _ВСервисе;
			
		КонецЦикла;
	КонецЦикла;
	
	_нз.Записать();
	
КонецПроцедуры
