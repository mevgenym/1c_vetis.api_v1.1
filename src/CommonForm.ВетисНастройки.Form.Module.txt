
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	#Если МобильноеПриложениеСервер Тогда
		Элементы.НастройкиПодключенияКомандаОсновная.Видимость = Ложь;
	#КонецЕсли
	
	//ВерсияAPI                = Ветис.Версия();
	//Тестовый                 = Ветис.Настройки_Тестовый();
	//Сервис                   = Ветис.Настройки_ЦелевойСервис();
	Отладка                  = Ветис.РазрешенаОтладка();
	ЖурналОпераций           = Ветис.Настройки_ЖурналОпераций();
	
	ОсновнаяНастройка        = Ветис.Настройки_ОсновнаяНастройка();
	ОсновнойПользователь     = Ветис.Настройки_ОсновнойПользователь();
	//ОсновнойХС               = Ветис.Настройки_ОсновнойХС();
	
	ВремяОжиданияОтвета       = Ветис.Настройки_ВремяОжиданияОтвета();
	Интеграция                = Ветис.Настройки_Интеграция();
	Префикс                   = Ветис.Настройки_Префикс();
	ОберткаHttp               = Ветис.Настройки_ОберткаHttp();
	КоличествоОбъектовВСписке = Ветис.Настройки_КоличествоОбъектовВСписке();
	
	ПоказыватьGuid           = Ветис.Настройки_ПоказыватьGuid();
	
	МногоуровневаяУпаковка   = Ветис.Настройки_МногоуровневаяУпаковка();
	УровеньУпаковки          = Ветис.Настройки_УровеньУпаковки();
	КлассМаркировки          = Ветис.Настройки_КлассМаркировки();
	ЛабораторныеИсследования = Ветис.Настройки_ЛабораторныеИсследования();
	Мероприятия              = Ветис.Настройки_Мероприятия();
	МультимодальныеПеревозки = Ветис.Настройки_МультимодальныеПеревозки();
	УсловияПеремещения       = Ветис.Настройки_УсловияПеремещения();
	
	ВСД_БлагополучиеМестности = Ветис.Настройки_ВСД_БлагополучиеМестности();
	ВСД_ВСЭ                   = Ветис.Настройки_ВСД_ВСЭ();
	ВСД_КонтрольГосВетврачем  = Ветис.Настройки_ВСД_КонтрольГосВетврачем();
	ВСД_НазначениеГруза       = Ветис.Настройки_ВСД_НазначениеГруза();
	ВСД_ОсобыеОтметки         = Ветис.Настройки_ВСД_ОсобыеОтметки();
	
	УстановитьВидимость();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	
	Если Модифицированность Тогда
		_Ответ = Вопрос("Записать изменения?", РежимДиалогаВопрос.ДаНетОтмена);
		Если _Ответ = КодВозвратаДиалога.Да Тогда
			КомандаГотовоНаСервере();
		ИначеЕсли _Ответ = КодВозвратаДиалога.Отмена Тогда
			Отказ = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура КомандаГотово(Команда)
	
	КомандаГотовоНаСервере();
	
	Оповестить("ВетисНастройки");
	
	Закрыть();
	
КонецПроцедуры

&НаСервере
Процедура КомандаГотовоНаСервере()
	
	//Ветис.ВерсияУстановить(ВерсияAPI);
	//Ветис.Настройки_Тестовый(Тестовый);
	//Ветис.Настройки_ЦелевойСервис(Сервис);
	Ветис.РазрешенаОтладка(Отладка);
	Ветис.Настройки_ЖурналОпераций(ЖурналОпераций);
	
	Ветис.Настройки_ОсновнаяНастройка(ОсновнаяНастройка);
	Ветис.Настройки_ОсновнойПользователь(ОсновнойПользователь);
	//Ветис.Настройки_ОсновнойХС(ОсновнойХС);
	
	Ветис.Настройки_ВремяОжиданияОтвета(ВремяОжиданияОтвета);
	Ветис.Настройки_Интеграция(Интеграция);
	Ветис.Настройки_Префикс(Префикс);
	Ветис.Настройки_ОберткаHttp(ОберткаHttp);
	Ветис.Настройки_КоличествоОбъектовВСписке(КоличествоОбъектовВСписке);
	
	Ветис.Настройки_ПоказыватьGuid(ПоказыватьGuid);
	
	Ветис.Настройки_МногоуровневаяУпаковка(МногоуровневаяУпаковка);
	Ветис.Настройки_УровеньУпаковки(УровеньУпаковки);
	Ветис.Настройки_КлассМаркировки(КлассМаркировки);
	Ветис.Настройки_ЛабораторныеИсследования(ЛабораторныеИсследования);
	Ветис.Настройки_Мероприятия(Мероприятия);
	Ветис.Настройки_МультимодальныеПеревозки(МультимодальныеПеревозки);
	Ветис.Настройки_УсловияПеремещения(УсловияПеремещения);
	
	Ветис.Настройки_ВСД_БлагополучиеМестности(ВСД_БлагополучиеМестности);
	Ветис.Настройки_ВСД_ВСЭ(ВСД_ВСЭ);
	Ветис.Настройки_ВСД_КонтрольГосВетврачем(ВСД_КонтрольГосВетврачем);
	Ветис.Настройки_ВСД_НазначениеГруза(ВСД_НазначениеГруза);
	Ветис.Настройки_ВСД_ОсобыеОтметки(ВСД_ОсобыеОтметки);
	
	Ветис.ИнициализироватьНастройкиПодключения();
	
	//Ветис.ИнициализироватьНастройкиХС();
	
	//Ветис.ИнициализироватьНастройкиПользователя();
	
	Модифицированность = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаОсновнаяНастройка(Команда)
	
	ОсновнаяНастройка = Элементы.НастройкиПодключения.ТекущиеДанные.Ссылка;
	
	Модифицированность = Истина;
	
	Элементы.НастройкиПодключения.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаОсновнойПользователь(Команда)
	
	ОсновнойПользователь = Элементы.СписокПользователи.ТекущиеДанные.Ссылка;
	
	Модифицированность = Истина;
	
	Элементы.СписокПользователи.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗаполнитьXSD(Команда)
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСинхронизация(Команда)
	
	ВетисСинхронизацияВызовСервера.ЗапуститьФоновое("Синхронизвать");
	
	ПоказатьПредупреждение(Новый ОписаниеОповещения("СинхронизацияОбработкаОповещения", ЭтаФорма),"Синхронизация запущена в фоне");
	
КонецПроцедуры

&НаКлиенте
Процедура СинхронизацияОбработкаОповещения(Результат) Экспорт
	
КонецПроцедуры


&НаКлиенте
Процедура МногоуровневаяУпаковкаПриИзменении(Элемент)
	
	УстановитьВидимость();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимость(пИмяСобытия = Неопределено)
	
	Элементы.УровеньУпаковки.Видимость = НЕ МногоуровневаяУпаковка;
	Элементы.КлассМаркировки.Видимость = НЕ МногоуровневаяУпаковка;
	
	#Если НЕ МобильноеПриложениеСервер Тогда
		Элементы.ГруппаСистемные.Видимость = РольДоступна("ВетисАдминистратор");
	#КонецЕсли
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПользователиЗаполнить(Команда)
	
	Перем _Отказ, _Ошибка;
	
	Сообщить("Пользователей необходимо заполнить вручную и связать с пользователями ИБ");
	
	Возврат;
	
	Если НЕ ЗначениеЗаполнено(ОтборХС) Тогда
		Сообщить("Необходимо выбрать ХС");
		Возврат;
	КонецЕсли;
	
	ПользователиЗаполнитьСервер(_Отказ, _Ошибка);
	
	Если _Отказ = Истина Тогда
		Сообщить(_Ошибка);
		Возврат;
	КонецЕсли;
	
	Элементы.СписокПользователи.Обновить();
	
КонецПроцедуры

Процедура ПользователиЗаполнитьСервер(пОтказ, пОшибка)
	
	Перем _Параметры, _user;
	
	_issuerId = ВетисDictionaryСлой1с.BusinessEntity(ОтборХС);
	
	Пока ВетисMercuryApplications_2_0.GetBusinessEntityUserListNext(_issuerId, _user, _Параметры, пОтказ, пОшибка) Цикл
		
	КонецЦикла;
	
КонецПроцедуры
