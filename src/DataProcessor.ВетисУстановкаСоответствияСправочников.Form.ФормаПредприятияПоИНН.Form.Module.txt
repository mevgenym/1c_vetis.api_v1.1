
&НаСервере
Процедура КомандаНайтиНаСервере()
	
	_список = СтрРазделить(ИНН, Символы.ПС);
	
	_Таблица = Новый ТаблицаЗначений;
	_Таблица.Колонки.Добавить("ИНН", Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(12)));
	Для каждого _инн Из _список Цикл
		Если НЕ ПустаяСтрока(_инн) Тогда
			_Таблица.Добавить().инн = СокрЛП(_инн);
		КонецЕсли;
	КонецЦикла;
	
	//_инн = """" + СтрЗаменить(ИНН, Символы.ПС, """,""") + """";
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_Таблица.ИНН
	|ПОМЕСТИТЬ ВТаблица
	|ИЗ
	|	&ИНН КАК _Таблица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	_ИНН.ИНН,
	|	_BusinessEntity.guid,
	|	_BusinessEntity.Ссылка
	|ИЗ
	|	ВТаблица КАК _ИНН
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			_Таблица.Ссылка КАК Ссылка,
	|			_Таблица.inn КАК inn,
	|			_Таблица.guid КАК guid
	|		ИЗ
	|			Справочник.ВетисBusinessEntity КАК _Таблица
	|		ГДЕ
	|			ИСТИНА
	|			И _Таблица.last
	|			И _Таблица.active) КАК _BusinessEntity
	|		ПО _ИНН.ИНН = _BusinessEntity.inn
	|ГДЕ
	|	ИСТИНА");
	
	Запрос.УстановитьПараметр("ИНН", _Таблица);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	_Индекс = 1;
	Пока Выборка.Следующий() Цикл
		
		Заголовок = "" + _Индекс;
		
		//ОбработкаПрерыванияПользователя();
		
		_Отказ = Ложь; _Ошибка = "";
		
		Если Выборка.guid = NULL Тогда
			_список = ВетисEnterpriseService_2_0.GetBusinessEntityByINN(Выборка.ИНН, _Отказ, _Ошибка);
			Если _список.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			_guid = _список[0].guid;
			_be = ВетисDictionaryСлой1с.Enterprise(_guid);
		Иначе
			_guid = Выборка.guid;
			_be = Выборка.Ссылка;
		КонецЕсли;
		
		_нз = РегистрыСведений.ВетисBusinessMembers.СоздатьНаборЗаписей();
		_нз.Отбор.BusinessEntity.Установить(_be);
		
		_enterprise = Неопределено;
		_параметры = Неопределено;
		Пока ВетисEnterpriseService_2_0.GetActivityLocationListNext(_guid, _enterprise, _параметры, _Отказ, _Ошибка) Цикл
			_ent = ВетисDictionaryСлой1с.Enterprise(_enterprise);
			_мз = _нз.Добавить();
			_мз.Использовать = Истина;
			_мз.ВСервисе = Истина;
			_мз.BusinessEntity = _be;
			_мз.Enterprise   = _ent;
		КонецЦикла;
		
		_нз.Записать();
		
		_Индекс = _Индекс + 1;
		
	КонецЦикла;
	
	//Для каждого _инн Из _список Цикл
	//	
	//КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаНайти(Команда)
	КомандаНайтиНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ИННПриИзменении(Элемент)
	
	Элементы.ИНН.Заголовок = "ИНН (" + СтрЧислоСтрок(ИНН) + ")";
	
КонецПроцедуры
